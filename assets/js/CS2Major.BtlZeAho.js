import{v as he,c as ne,a as x,P as we,e as Te,Q as be,n as ye,O as ke}from"./element-plus.pEMcb2g5.js";import{d as H,r as p,w as Z,c as T,o as _,a as o,Q as C,u as O,I as M,D as R,O as P,P as le,a6 as de,V as ie,n as pe,k as ee,i as te,J as fe,M as N,K as B,W as ge,H as Pe,S as Ce}from"./@vue.Ca5AQEsS.js";import{d as G}from"./vuedraggable.DT4yJUdD.js";import{_ as J,h as K,u as _e}from"./index.CLQ9k19S.js";import{u as Ie}from"./vue-router.DhOS9MZH.js";import{S as $e,v as Se}from"./@element-plus.w7YOadmw.js";import{h as Me}from"./html2canvas.BfYXEYrK.js";import{S as Ve,P as Le,W as De,A as xe,O as Ee,a as Ae,D as me,b as Be,c as ze,R as Re,G as Ue,M as Fe,B as je,V as ve}from"./three.BX7nTO8R.js";import"./lodash-es.S0Y0Up6J.js";import"./@vueuse.BFkoDYlQ.js";import"./@popperjs.D_chPuIy.js";import"./@ctrl.r5W6hzzQ.js";import"./dayjs.DcnvBwdO.js";import"./async-validator.9PlIezaS.js";import"./memoize-one.BdPwpGay.js";import"./normalize-wheel-es.BQoi3Ox2.js";import"./@floating-ui.58V2siOx.js";import"./vue.CP_DfUbm.js";import"./sortablejs.YiSzADr_.js";import"./pinia.Dz8zdBJG.js";import"./axios.xsH4HHeE.js";import"./js-cookie.Cz0CWeBA.js";const We={class:"major-predict-root"},Ne={class:"team-pool"},Oe=["src","alt"],He={class:"team-name"},qe={class:"predict-area"},Ge={class:"predict-row"},Ke={class:"predict-block"},Qe={class:"predict-label"},Ze=["src","alt"],Je={class:"team-name"},Ye=["onClick","disabled"],Xe={class:"predict-block"},et={class:"predict-label"},tt=["src","alt"],at={class:"team-name"},st=["onClick","disabled"],ot={class:"predict-row advance-row"},it={class:"advance-label"},nt=["src","alt"],lt={class:"team-name"},dt=["onClick","disabled"],rt=H({name:"MatchPredictionBase"}),ct=H({...rt,props:{teams:{},firstLabel:{},secondLabel:{},advanceLabel:{},maxAdvance:{},isTimeValid:{type:Boolean}},setup(D,{expose:U}){const f=D,L={name:"teams"},d=p([]),l=p([]),r=p([]),u=p([]);Z(()=>f.teams,t=>{const a=Array.from(new Map(t.map(e=>[e.id,e])).values());d.value=[...a]},{immediate:!0});function b(t){const a=t.draggedContext.element;return t.from&&!t.from.classList.contains("team-list")&&t.to.classList.contains("predict-slot")?!0:!(I(a.id,a.name)||l.value.length>=2)}function v(t){const a=t.draggedContext.element;return t.from&&!t.from.classList.contains("team-list")&&t.to.classList.contains("predict-slot")?!0:!(I(a.id,a.name)||r.value.length>=2)}function h(t){const a=t.draggedContext.element;return!w(t.from)&&t.to.classList.contains("predict-slot")?!0:!I(a.id,a.name)}function w(t){return t&&t.classList&&t.classList.contains("team-list")}function I(t,a){return l.value.some(e=>e.id===t||e.name===a)||r.value.some(e=>e.id===t||e.name===a)||u.value.some(e=>e.id===t||e.name===a)}function $(t){if(t.added){const e=t.added.element;r.value=r.value.filter(i=>i.id!==e.id),u.value=u.value.filter(i=>i.id!==e.id)}if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(l.value.map(e=>[e.id,e])).values());l.value.splice(0,l.value.length,...a),l.value.length>2&&l.value.splice(2).forEach(i=>{d.value.some(y=>y.id===i.id)||d.value.push(i)}),s()}function E(t){if(t.added){const e=t.added.element;l.value=l.value.filter(i=>i.id!==e.id),u.value=u.value.filter(i=>i.id!==e.id)}if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(r.value.map(e=>[e.id,e])).values());r.value.splice(0,r.value.length,...a),r.value.length>2&&r.value.splice(2).forEach(i=>{d.value.some(y=>y.id===i.id)||d.value.push(i)}),s()}function z(t){if(t.added){const e=t.added.element;if(!t.from.classList.contains("team-list")&&t.added.newIndex!==void 0){if(t.removed){const i=t.removed.element;d.value.some(y=>y.id===i.id)||d.value.push(i)}}else if(u.value.length>f.maxAdvance&&t.removed){const i=t.removed.element;d.value.some(y=>y.id===i.id)||d.value.push(i)}l.value=l.value.filter(i=>i.id!==e.id),r.value=r.value.filter(i=>i.id!==e.id)}else if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(u.value.map(e=>[e.id,e])).values());u.value.splice(0,u.value.length,...a),s()}function V(t,a){let e;t==="first"?e=l.value.splice(a,1):e=r.value.splice(a,1),d.value.push(...e),s()}function m(t){const a=u.value.splice(t,1);d.value.push(...a),s()}function s(){pe(()=>{const t=[...l.value.map(a=>a.id),...r.value.map(a=>a.id),...u.value.map(a=>a.id)];d.value=d.value.filter(a=>!t.includes(a.id))})}return U({firstTeam:l,secondTeam:r,advanceTeams:u}),(t,a)=>(_(),T("div",We,[o("div",Ne,[C(O(G),{list:d.value,group:L,sort:!1,"item-key":"id",class:"team-list","ghost-class":"ghost",disabled:!t.isTimeValid},{item:M(({element:e})=>[(_(),T("div",{class:R(["team-card",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,Oe),o("div",He,P(e.name),1)],2))]),_:1},8,["list","disabled"])]),o("div",qe,[o("div",Ge,[o("div",Ke,[o("div",Qe,P(t.firstLabel),1),C(O(G),{list:l.value,group:L,sort:!1,"item-key":"id",class:"predict-slot big","ghost-class":"ghost",move:b,onChange:$,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:R(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,Ze),o("div",Je,P(e.name),1),o("button",{class:"remove-btn",onClick:ie(y=>V("first",i),["stop"]),disabled:!t.isTimeValid},"×",8,Ye)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,2-l.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])]),o("div",Xe,[o("div",et,P(t.secondLabel),1),C(O(G),{list:r.value,group:L,sort:!1,"item-key":"id",class:"predict-slot big","ghost-class":"ghost",move:v,onChange:E,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:R(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,tt),o("div",at,P(e.name),1),o("button",{class:"remove-btn",onClick:ie(y=>V("second",i),["stop"]),disabled:!t.isTimeValid},"×",8,st)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,2-r.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])])]),o("div",ot,[o("div",it,P(t.advanceLabel),1),C(O(G),{list:u.value,group:L,sort:!0,"item-key":"id",class:"predict-slot multi big","ghost-class":"ghost",move:h,onChange:z,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:R(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,nt),o("div",lt,P(e.name),1),o("button",{class:"remove-btn",onClick:ie(y=>m(i),["stop"]),disabled:!t.isTimeValid},"×",8,dt)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,t.maxAdvance-u.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])])])]))}}),ut=J(ct,[["__scopeId","data-v-7543f671"]]),Q={getMatchTeams(D,U){return K.get(`/machine/matches/${D}/teams`,{params:{phase:U}})},submitPrediction(D){return K.post("/machine/prediction/submit",D)},getUserPredictions(D){return K.get("/machine/prediction/records",{params:{matchId:D.matchId,phase:D.phase}})}},mt={class:"major-phase","element-loading-text":"加载队伍数据中..."},vt={class:"title"},ht={class:"save-button"},pt=H({name:"MajorPhase"}),ft=H({...pt,props:{isTimeValid:{type:Boolean},matchId:{},phase:{}},setup(D,{expose:U}){const f=D,L=ee(()=>({onePhase:"第一阶段",twoPhase:"第二阶段",threePhase:"第三阶段"})[f.phase]),d=_e(),l=p(),r=p([]),u=p([]),b=p([]),v=p([]),h=p(!1),w=p(!1),$=((s,t)=>{let a=null;return function(...e){a&&clearTimeout(a),a=setTimeout(()=>{s.apply(this,e),a=null},t)}})(()=>{f.isTimeValid&&(console.log("触发防抖保存..."),m())},300);Z(l,s=>{s&&Z([()=>s.firstTeam,()=>s.secondTeam,()=>s.advanceTeams],([t,a,e])=>{r.value=[...t],u.value=[...a],b.value=[...e],!h.value&&!w.value&&f.isTimeValid&&$()},{deep:!0})},{immediate:!0});const E=async()=>{try{h.value=!0,console.log(`获取${L.value}队伍数据，matchId:`,f.matchId);const s=await Q.getMatchTeams(f.matchId,f.phase);console.log("获取到的原始数据:",s.data),v.value=s.data.map(t=>({id:t.id,name:t.teamName,logo:t.teamImgUrl})),console.log("处理后的队伍数据:",v.value)}catch(s){console.error("获取队伍数据失败:",s),x.error("获取队伍数据失败")}finally{h.value=!1}},z=async()=>{var s;if(!f.matchId){console.warn("matchId未设置，跳过获取预测数据");return}try{w.value=!0,h.value=!0,v.value.length===0&&await E();const t=await Q.getUserPredictions({matchId:f.matchId,phase:f.phase,userId:d.userId});if(t.data){let a=Array.isArray(t.data)?t.data[0]:t.data;const e=new Set;if(a.sl){const i=a.sl.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));r.value=y,y.forEach(A=>e.add(A.id.toString()))}if(a.ls){const i=a.ls.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));u.value=y,y.forEach(A=>e.add(A.id.toString()))}if(a.advance){const i=a.advance.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));b.value=y,y.forEach(A=>e.add(A.id.toString()))}v.value=v.value.filter(i=>!e.has(i.id.toString())),l.value&&(l.value.firstTeam=[...r.value],l.value.secondTeam=[...u.value],l.value.advanceTeams=[...b.value])}else console.log("未找到用户之前的预测数据")}catch(t){if(((s=t.response)==null?void 0:s.status)===401){console.log("用户未登录，跳过获取预测数据");return}console.error("获取预测数据失败:",t),x.error("获取预测数据失败")}finally{h.value=!1,setTimeout(()=>{w.value=!1},100)}},V=()=>{const s=[];return r.value.length!==2&&s.push("请选择2支3-0队伍"),u.value.length!==2&&s.push("请选择2支0-3队伍"),b.value.length!==6&&s.push("请选择6支晋级队伍"),s},m=async()=>{var t;const s=V();s.length>0&&x.warning(s.join(`
`));try{const a={matchId:f.matchId,phase:f.phase,s_l:r.value.map(i=>i.id.toString()).join(","),l_s:u.value.map(i=>i.id.toString()).join(","),advance:b.value.map(i=>i.id)},e=await Q.submitPrediction(a);x.success("预测数据保存成功")}catch(a){if(((t=a.response)==null?void 0:t.status)===401){x.warning("请先登录后再进行预测");return}console.error("保存预测数据失败:",a),x.error("保存预测数据失败")}};return te(async()=>{f.matchId&&(await E(),await z())}),U({getPredictData(){return{firstTeam:r.value,secondTeam:u.value,advanceTeams:b.value}},fetchTeams:E,fetchUserPrediction:z,validateAndSavePrediction:m}),(s,t)=>{const a=ne,e=he;return fe((_(),T("div",mt,[o("h2",vt,P(L.value)+"竞猜作业",1),C(ut,{ref_key:"predictRef",ref:l,teams:v.value,"first-label":"全胜晋级","second-label":"全败出局","advance-label":"晋级的另外6支队伍","max-advance":6,isTimeValid:s.isTimeValid,"onUpdate:firstTeam":t[0]||(t[0]=i=>r.value=i),"onUpdate:secondTeam":t[1]||(t[1]=i=>u.value=i),"onUpdate:advanceTeams":t[2]||(t[2]=i=>b.value=i)},null,8,["teams","isTimeValid"]),o("div",ht,[C(a,{onClick:m,disabled:!s.isTimeValid},{default:M(()=>t[3]||(t[3]=[N("保存预测")])),_:1,__:[3]},8,["disabled"])])])),[[e,h.value]])}}}),re=J(ft,[["__scopeId","data-v-9a698311"]]),gt={class:"major-champion","element-loading-text":"加载队伍数据中..."},_t={class:"bracket-container"},wt={class:"bracket-stage"},Tt={class:"matches"},bt={class:"match"},yt=["src","alt"],kt={class:"team-name"},Pt={key:0,class:"empty-slot"},Ct={class:"bracket-stage champion-stage"},It={class:"matches"},$t=["src","alt"],St={class:"team-name"},Mt=["onClick","disabled"],Vt={key:0,class:"empty-slot champion-empty"},Lt={class:"save-button"},Dt=H({name:"MajorChampion"}),xt=H({...Dt,props:{isTimeValid:{type:Boolean},matchId:{}},setup(D,{expose:U}){const f=D,L=_e(),d=p(!1),l=p([]),u=((m,s)=>{let t=null;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{m.apply(this,a),t=null},s)}})(()=>{f.isTimeValid&&(console.log("触发防抖保存冠军预测..."),V())},300),b=async()=>{try{d.value=!0,console.log("获取冠军组队伍数据，matchId:",f.matchId);const m=await Q.getMatchTeams(f.matchId,"champion");console.log("获取到的原始数据:",m.data),l.value=m.data.map(s=>({id:s.id,name:s.teamName,logo:s.teamImgUrl})),console.log("处理后的队伍数据:",l.value)}catch(m){console.error("获取队伍数据失败:",m),x.error("获取队伍数据失败")}finally{d.value=!1}},v=async()=>{var m;if(!f.matchId){console.warn("matchId未设置，跳过获取预测数据");return}try{d.value=!0,l.value.length===0&&await b();const s=await Q.getUserPredictions({matchId:f.matchId,phase:"champion",userId:L.userId});if(s.data){let t=Array.isArray(s.data)?s.data[0]:s.data;const a=new Set;if(t.advance){const e=t.advance.split(","),i=l.value.filter(y=>e.includes(y.id.toString()));w.value=i,i.forEach(y=>a.add(y.id.toString()))}l.value=l.value.filter(e=>!a.has(e.id.toString()))}else console.log("未找到用户之前的预测数据")}catch(s){if(((m=s.response)==null?void 0:m.status)===401){console.log("用户未登录，跳过获取预测数据");return}console.error("获取预测数据失败:",s),x.error("获取预测数据失败")}finally{d.value=!1}};te(async()=>{f.matchId&&(await b(),await v())});const h={name:"teams"},w=p([]);Z(w,()=>{u()},{deep:!0});const I=m=>{switch(m){case"champion":return w;default:return p([])}},$=m=>{const s=m.from.parentElement.id,t=m.to.parentElement.id;return!s||!t?!1:t==="champion"},E=(m,s)=>{if(m.added){const t=m.added.element;if(w.value.length>1){const a=w.value.findIndex(e=>e.id!==t.id);if(a!==-1){const e=w.value.splice(a,1)[0];l.value.push(e),l.value.sort((i,y)=>i.id-y.id)}}}else if(m.removed){const t=m.removed.element;l.value.some(a=>a.id===t.id)||(l.value.push(t),l.value.sort((a,e)=>a.id-e.id))}};function z(m,s){const t=I(m),a=t.value.findIndex(e=>e.id===s);if(a!==-1){const e=t.value.splice(a,1)[0];l.value.push(e),l.value.sort((i,y)=>i.id-y.id)}}const V=async()=>{var m;if(w.value.length!==1){x.warning("请选择一支冠军队伍！");return}try{const s={matchId:f.matchId,phase:"champion",s_l:"",l_s:"",advance:[w.value[0].id],champion:""},t=await Q.submitPrediction(s);x.success("冠军预测保存成功！")}catch(s){if(((m=s.response)==null?void 0:m.status)===401){x.warning("请先登录后再进行预测！");return}console.error("保存冠军预测失败:",s),x.error("保存冠军预测失败！")}};return U({getPredictData(){return{champion:w.value}},fetchTeams:b,fetchUserPrediction:v,saveChampionPrediction:V}),(m,s)=>{const t=ne,a=he;return fe((_(),T("div",gt,[s[5]||(s[5]=o("h2",{class:"title"},"冠军竞猜",-1)),o("div",_t,[o("div",wt,[s[1]||(s[1]=o("div",{class:"stage-title"},"冠军组队伍",-1)),o("div",Tt,[o("div",bt,[C(O(G),{list:l.value,group:h,"item-key":"id",class:"slot teams-grid","ghost-class":"ghost",disabled:!m.isTimeValid},{item:M(({element:e})=>[o("div",{class:R(["team-card",{disabled:!m.isTimeValid}])},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,yt),o("div",kt,P(e.name),1)],2)]),footer:M(()=>[l.value.length===0?(_(),T("div",Pt,"暂无队伍")):B("",!0)]),_:1},8,["list","disabled"])])])]),s[3]||(s[3]=o("div",{class:"connector-column third"},null,-1)),o("div",Ct,[s[2]||(s[2]=o("div",{class:"stage-title"},"冠军",-1)),o("div",It,[C(O(G),{id:"champion",list:w.value,group:h,"item-key":"id",class:"slot champion-slot","ghost-class":"ghost",onChange:s[0]||(s[0]=e=>E(e)),move:$,max:1,disabled:!m.isTimeValid},{item:M(({element:e})=>[o("div",{class:R(["team-card selected",{disabled:!m.isTimeValid}])},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,$t),o("div",St,P(e.name),1),o("button",{class:"remove-btn",onClick:ie(i=>z("champion",e.id),["stop"]),disabled:!m.isTimeValid},"×",8,Mt)],2)]),footer:M(()=>[w.value.length===0?(_(),T("div",Vt,"？")):B("",!0)]),_:1},8,["list","disabled"])])])]),o("div",Lt,[C(t,{onClick:V,disabled:!m.isTimeValid},{default:M(()=>s[4]||(s[4]=[N("保存预测")])),_:1,__:[4]},8,["disabled"])])])),[[a,d.value]])}}}),Et=J(xt,[["__scopeId","data-v-d2767f82"]]),At={class:"coin-buttons"},Bt={key:0,class:"debug-info"},zt=H({__name:"MatchCoinBase",props:{debug:{type:Boolean}},emits:["update:coinType","loading","model-loaded","progress"],setup(D,{emit:U}){const f=D,L=p(f.debug!==void 0?f.debug:!0);console.log("MatchCoinBase - debugInfo:",L.value);const d=p(""),l=p("初始化中..."),r=p(null);let u,b,v,h;const w=U,I={bronze:"#B08D57",silver:"#696969",gold:"#81FF08",diamond:"#BFD8EF"},$=p("gold"),E=a=>{$.value=a,z()},z=()=>{if(!u)return;const a=I[$.value];u.traverse(e=>{e.isMesh&&e.material&&(e.material.color.set(a),e.material.needsUpdate=!0)})},V=()=>{if(r.value){const a=r.value.getBoundingClientRect();d.value=`宽度: ${a.width}px, 高度: ${a.height}px`}},m=()=>{try{if(l.value="创建场景...",u=new Ve,console.log("场景创建成功"),l.value="创建相机...",b=new Le(75,r.value?r.value.clientWidth/r.value.clientHeight:1,.1,1e3),b.position.set(0,0,5),console.log("相机创建成功"),l.value="创建渲染器...",v=new De({antialias:!0}),!r.value)throw new Error("容器元素不存在");const a=r.value.clientWidth,e=r.value.clientHeight;v.setSize(a,e),v.setPixelRatio(window.devicePixelRatio),r.value.appendChild(v.domElement),console.log("渲染器创建成功，尺寸:",a,e),v.toneMapping=xe,v.toneMappingExposure=1,h=new Ee(b,v.domElement),h.enableDamping=!0,h.dampingFactor=.05,console.log("控制器创建成功");const i=new Ae(16777215,1);u.add(i);const y=new me(16777215,1);y.position.set(5,5,5),u.add(y);const A=new me(16777215,.8);A.position.set(-5,5,-5).normalize(),u.add(A);const q=new Be(16777215,1,100);q.position.set(0,2,0),u.add(q),console.log("灯光移除，将使用环境贴图提供照明");const Y=new ze(v);Y.compileEquirectangularShader(),l.value="加载环境贴图...",new Re().load("https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/the_sky_is_on_fire_1k.hdr",c=>{const k=Y.fromEquirectangular(c).texture;Y.dispose(),c.dispose(),u.environment=k,u.background=k,console.log("环境贴图加载并应用成功"),l.value="环境贴图加载成功"},void 0,c=>{console.error("加载环境贴图错误:",c),l.value="环境贴图加载失败: "+(c instanceof Error?c.message:String(c))}),l.value="开始加载模型...";const n=new Ue;console.log("开始加载模型..."),n.load("/b.glb",c=>{console.log("模型加载成功"),l.value="模型加载成功",w("loading",l.value),u.add(c.scene);const k=new Fe({metalness:1,roughness:0,color:I[$.value]});u.traverse(j=>{j.isMesh&&(console.log("检查到网格对象:",j.name),j.material=k,console.log("已为网格对象应用 MeshStandardMaterial"),(j.material.isMeshStandardMaterial||j.material.isMeshPhysicalMaterial)&&u.environment&&(j.material.envMap=u.environment,j.material.needsUpdate=!0,console.log("已为标准/物理材质设置环境贴图")))});const S=new je().setFromObject(c.scene),F=S.getCenter(new ve),W=S.getSize(new ve),ae=Math.max(W.x,W.y,W.z),se=b.fov*(Math.PI/180);let oe=Math.abs(ae/Math.sin(se/2))*.8;b.position.set(F.x-oe,F.y,F.z),b.lookAt(F),h.target.copy(F),h.update(),console.log("相机位置调整完成"),setTimeout(()=>{console.log("发送模型加载完成事件"),w("model-loaded")},100)},c=>{const k=c.loaded/c.total*100;console.log("加载进度:",k.toFixed(2)+"%"),l.value=`模型加载进度: ${k.toFixed(0)}%`,w("loading",l.value),w("progress",k)},c=>{console.error("模型加载错误:",c),l.value="模型加载失败: "+(c instanceof Error?c.message:String(c)),w("loading",l.value)}),V()}catch(a){console.error("初始化场景失败:",a),l.value="初始化失败: "+a.message}},s=()=>{requestAnimationFrame(s),h==null||h.update(),v==null||v.render(u,b)},t=()=>{if(!r.value||!b||!v)return;const a=r.value.clientWidth,e=r.value.clientHeight;console.log("handleResize - 容器尺寸:",a,e),b.aspect=r.value?a/e:b.aspect,b.updateProjectionMatrix(),v.setSize(a,e),V(),console.log("handleResize - 相机宽高比更新为:",b.aspect)};return te(()=>{console.log("组件挂载，容器元素:",r.value),window.addEventListener("resize",t),l.value="初始化场景...",pe(()=>{var a,e;V(),console.log("nextTick - 容器尺寸:",(a=r.value)==null?void 0:a.clientWidth,(e=r.value)==null?void 0:e.clientHeight),r.value&&console.log("nextTick - 相机宽高比:",r.value.clientWidth/r.value.clientHeight),m(),s()})}),ge(()=>{window.removeEventListener("resize",t),r.value&&v&&r.value.removeChild(v.domElement),v==null||v.dispose(),u&&u.traverse(a=>{if(a.geometry&&a.geometry.dispose(),a.material)if(Array.isArray(a.material))for(const e of a.material)e.dispose();else a.material.dispose();a.texture&&a.texture.dispose()})}),(a,e)=>(_(),T("div",{class:"model-container",ref_key:"container",ref:r},[o("div",At,[o("button",{onClick:e[0]||(e[0]=i=>E("bronze")),class:R({active:$.value==="bronze"})},"铜币",2),o("button",{onClick:e[1]||(e[1]=i=>E("silver")),class:R({active:$.value==="silver"})},"银币",2),o("button",{onClick:e[2]||(e[2]=i=>E("gold")),class:R({active:$.value==="gold"})},"金币",2),o("button",{onClick:e[3]||(e[3]=i=>E("diamond")),class:R({active:$.value==="diamond"})},"钻石币",2)]),L.value?(_(),T("div",Bt,[o("p",null,"容器尺寸: "+P(d.value),1),o("p",null,"加载状态: "+P(l.value),1)])):B("",!0)],512))}}),Rt=J(zt,[["__scopeId","data-v-fe16f9e7"]]),Ut={class:"coin-preview-container"},Ft={key:0,class:"loading-overlay"},jt={class:"loading-text"},Wt={class:"dialog-footer"},Nt=H({__name:"CoinPreviewDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(D,{emit:U}){const f=D,L=U,d=ee({get:()=>f.modelValue,set:s=>L("update:modelValue",s)}),l=p("gold"),r=p(!1),u=ee(()=>r.value?"100%":"80%"),b=ee(()=>r.value?"80vh":"70vh"),v=p(!0),h=p(0),w=p("初始化..."),I=()=>{r.value=window.innerWidth<=768},$=s=>{l.value=s},E=s=>{w.value=s,console.log("加载状态:",s)},z=s=>{h.value=Math.floor(s),h.value>=100&&(w.value="加载完成...")},V=()=>{console.log("收到模型加载完成事件"),setTimeout(()=>{v.value=!1,h.value=100,w.value="加载完成",console.log("加载叠加层应已隐藏")},300)},m=()=>{v.value=!0,h.value=0,w.value="初始化...",l.value="gold"};return te(()=>{I(),window.addEventListener("resize",I)}),ge(()=>{window.removeEventListener("resize",I)}),Z(d,s=>{console.log("对话框状态变化:",s),s&&(v.value=!0,h.value=0,w.value="初始化...")}),(s,t)=>{const a=ne,e=Te;return _(),Pe(e,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=i=>d.value=i),title:"3D预览奖章,加载约30秒左右",width:u.value,fullscreen:!r.value,draggable:"","destroy-on-close":"",onClosed:m,"close-on-click-modal":!1},{footer:M(()=>[o("div",Wt,[C(a,{onClick:t[0]||(t[0]=i=>d.value=!1)},{default:M(()=>t[2]||(t[2]=[N("关闭")])),_:1,__:[2]})])]),default:M(()=>[o("div",Ut,[C(Rt,{ref:"coinViewer",debug:!1,"initial-coin-type":l.value,"container-height":b.value,"onUpdate:coinType":$,onLoading:E,onModelLoaded:V,onProgress:z},null,8,["initial-coin-type","container-height"]),v.value||h.value<100?(_(),T("div",Ft,[C(O(we),{type:"circle",percentage:h.value,width:r.value?90:100,"stroke-width":10,color:"#409eff"},null,8,["percentage","width"]),o("div",jt,P(w.value),1)])):B("",!0)])]),_:1},8,["modelValue","width","fullscreen"])}}}),Ot=J(Nt,[["__scopeId","data-v-6daef79c"]]),Ht={class:"cs2-major-root"},qt={class:"major-container"},Gt={key:0,class:"loading-container"},Kt={key:1,class:"prediction-content"},Qt={class:"tab-buttons"},Zt={key:0,class:"countdown"},Jt={key:0,class:"countdown"},Yt={key:0,class:"countdown"},Xt={key:0,class:"countdown"},ea={class:"major-content"},ta={class:"match-info-panel"},aa={class:"match-header"},sa=["src","alt"],oa={class:"match-name"},ia={class:"match-details"},na={class:"info-item"},la={class:"value"},da={class:"info-item"},ra={class:"value"},ca={class:"info-item"},ua={class:"value"},ma={class:"match-footer"},va={class:"button-group"},ha={class:"button-group"},pa={key:0,class:"major-section"},fa={class:"time-info"},ga={key:1,class:"major-section"},_a={class:"time-info"},wa={key:2,class:"major-section"},Ta={class:"time-info"},ba={key:3,class:"major-section"},ya={class:"time-info"},ka={key:2,class:"no-match"},Pa=H({__name:"CS2Major",setup(D,{expose:U}){Ie();const f=p(0),L=p(!0),d=p("onePhase"),l=p(),r=p(),u=p(),b=p(),v=p(null),h=p(null),w=p(!1),I=p({}),$=p({onePhase:{start:new Date,end:new Date},twoPhase:{start:new Date,end:new Date},threePhase:{start:new Date,end:new Date},champion:{start:new Date,end:new Date}}),E=ee(()=>Object.keys(I.value).length>0),z=g=>new Date(g).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Shanghai"}).replace(/\//g,"年").replace(",","日"),V=g=>{const{start:n,end:c}=$.value[g];return`${z(n.toISOString())}日 ${n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})} - ${z(c.toISOString())}日 ${c.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})}`},m=async()=>{try{L.value=!0;const g=await K.get("/machine/matches");if(g.data&&g.data.length>0){const n=g.data;n.length>0?(n.forEach(c=>{I.value[c.phase]=c}),I.value[d.value]||(d.value=Object.keys(I.value)[0]),s(d.value),n.forEach(c=>{const k=c.phase;k in $.value&&($.value[k]={start:new Date(c.predictStartTime),end:new Date(c.predictEndTime)})}),console.log("比赛信息:",n),console.log("时间限制设置:",$.value)):x.error("未找到可用赛事")}else x.error("未找到可用赛事")}catch(g){console.error("获取赛事ID失败:",g),x.error("获取赛事ID失败")}finally{L.value=!1}},s=g=>{const n=I.value[g];n?(f.value=n.id||0,h.value=n):(f.value=0,h.value=null)},t=g=>{const n=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Shanghai"})),{start:c,end:k}=$.value[g];return n>=c&&n<=k},a=g=>{const n=new Date,{start:c,end:k}=$.value[g];if(n<c){const S=c.getTime()-n.getTime();return`距离开始还有 ${e(S)}`}else{if(n>k)return"竞猜已结束";{const S=k.getTime()-n.getTime();return`距离结束还有 ${e(S)}`}}},e=g=>{const n=Math.floor(g/864e5),c=Math.floor(g%(1e3*60*60*24)/(1e3*60*60)),k=Math.floor(g%(1e3*60*60)/(1e3*60)),S=Math.floor(g%(1e3*60)/1e3);return`${n}天${c}小时${k}分${S}秒`},i=()=>{d.value=d.value};Z(d,g=>{var n,c,k,S;if(s(g),f.value)switch(g){case"onePhase":(n=l.value)==null||n.fetchTeams();break;case"twoPhase":(c=r.value)==null||c.fetchTeams();break;case"threePhase":(k=u.value)==null||k.fetchTeams();break;case"champion":(S=b.value)==null||S.fetchTeams();break}}),te(async()=>{await m(),v.value=window.setInterval(i,1e3)}),Ce(()=>{v.value&&clearInterval(v.value)}),U({getPredictData(){var g,n,c,k;return{onePhase:(g=l.value)==null?void 0:g.getPredictData(),twoPhase:(n=r.value)==null?void 0:n.getPredictData(),threePhase:(c=u.value)==null?void 0:c.getPredictData(),champion:(k=b.value)==null?void 0:k.getPredictData()}}});const y=g=>{const n=document.createElement("canvas");n.width=g.width,n.height=g.height+60;const c=n.getContext("2d");if(!c)return g;c.drawImage(g,0,0),c.font="bold 36px Microsoft YaHei",c.textAlign="center",c.textBaseline="bottom";const k="竞猜作业来源：sb6657.cn",S=n.width/2,F=n.height-20,W=c.measureText(k).width;return c.fillStyle="rgba(0, 0, 0, 0.5)",c.fillRect(S-W/2-10,F-40,W+20,40),c.fillStyle="#ffffff",c.fillText(k,S,F),n},A=async()=>{const g="玩机器烂梗库官方比赛作业，地址sb6657.cn";try{await navigator.clipboard.writeText(g)}catch(n){console.error("复制失败:",n)}try{w.value=!0;const n=document.querySelector(".major-section");if(!n)throw new Error("未找到要截图的元素");const c=await Me(n,{backgroundColor:"#ffffff",scale:1.5,logging:!1,useCORS:!0,allowTaint:!0}),k=y(c),S=document.createElement("a");S.download=`sb6657.cn_CS2Major预测_${new Date().toLocaleDateString()}.jpg`,S.href=k.toDataURL("image/jpeg",1),S.click(),x.success("截图已保存"),K.get("/machine/shareMatch")}catch(n){console.error("截图失败:",n),x.error("截图失败，请重试")}finally{w.value=!1}},q=p(!1);function Y(){q.value=!0,K.get("/machine/matchCoin")}return(g,n)=>{var W,ae,se,oe,j,ce,ue;const c=be,k=ye,S=ne,F=ke;return _(),T("div",Ht,[o("div",qt,[L.value?(_(),T("div",Gt,[C(c,{rows:3,animated:""})])):E.value?(_(),T("div",Kt,[o("div",Qt,[I.value.onePhase?(_(),T("button",{key:0,class:R({active:d.value==="onePhase"}),onClick:n[0]||(n[0]=X=>d.value="onePhase")},[n[5]||(n[5]=N(" 第一阶段 ")),d.value==="onePhase"?(_(),T("div",Zt,P(a("onePhase")),1)):B("",!0)],2)):B("",!0),I.value.twoPhase?(_(),T("button",{key:1,class:R({active:d.value==="twoPhase"}),onClick:n[1]||(n[1]=X=>d.value="twoPhase")},[n[6]||(n[6]=N(" 第二阶段 ")),d.value==="twoPhase"?(_(),T("div",Jt,P(a("twoPhase")),1)):B("",!0)],2)):B("",!0),I.value.threePhase?(_(),T("button",{key:2,class:R({active:d.value==="threePhase"}),onClick:n[2]||(n[2]=X=>d.value="threePhase")},[n[7]||(n[7]=N(" 第三阶段 ")),d.value==="threePhase"?(_(),T("div",Yt,P(a("threePhase")),1)):B("",!0)],2)):B("",!0),I.value.champion?(_(),T("button",{key:3,class:R({active:d.value==="champion"}),onClick:n[3]||(n[3]=X=>d.value="champion")},[n[8]||(n[8]=N(" 冠军组 ")),d.value==="champion"?(_(),T("div",Xt,P(a("champion")),1)):B("",!0)],2)):B("",!0)]),o("div",ea,[o("div",ta,[o("div",aa,[o("img",{src:(W=h.value)==null?void 0:W.matchesImg,alt:(ae=h.value)==null?void 0:ae.matchesName,class:"match-logo"},null,8,sa),o("h2",oa,P((se=h.value)==null?void 0:se.matchesName),1)]),o("div",ia,[o("div",na,[n[9]||(n[9]=o("span",{class:"label"},"赛事等级：",-1)),o("span",la,P((oe=h.value)==null?void 0:oe.level),1)]),o("div",da,[n[10]||(n[10]=o("span",{class:"label"},"比赛地点：",-1)),o("span",ra,P((j=h.value)==null?void 0:j.matchesLocation),1)]),o("div",ca,[n[11]||(n[11]=o("span",{class:"label"},"比赛时间：",-1)),o("span",ua,P(z((ce=h.value)==null?void 0:ce.startTime))+"日 - "+P(z((ue=h.value)==null?void 0:ue.endTime))+"日",1)])]),o("div",ma,[o("div",va,[C(S,{type:"primary",onClick:A,loading:w.value},{default:M(()=>[C(k,null,{default:M(()=>[C(O($e))]),_:1}),n[12]||(n[12]=N(" 截图分享预测 "))]),_:1,__:[12]},8,["loading"])]),o("div",ha,[C(S,{type:"success",onClick:Y},{default:M(()=>[C(k,null,{default:M(()=>[C(O(Se))]),_:1}),n[13]||(n[13]=N(" 预览2025奥斯汀Major3D奖章 "))]),_:1,__:[13]})])])]),d.value==="onePhase"?(_(),T("div",pa,[o("div",fa,[o("p",null,"竞猜时间："+P(V("onePhase")),1)]),C(re,{ref_key:"onePhaseRef",ref:l,isTimeValid:t("onePhase"),matchId:f.value,phase:"onePhase"},null,8,["isTimeValid","matchId"])])):B("",!0),d.value==="twoPhase"?(_(),T("div",ga,[o("div",_a,[o("p",null,"竞猜时间："+P(V("twoPhase")),1)]),C(re,{ref_key:"twoPhaseRef",ref:r,isTimeValid:t("twoPhase"),matchId:f.value,phase:"twoPhase"},null,8,["isTimeValid","matchId"])])):B("",!0),d.value==="threePhase"?(_(),T("div",wa,[o("div",Ta,[o("p",null,"竞猜时间："+P(V("threePhase")),1)]),C(re,{ref_key:"threePhaseRef",ref:u,isTimeValid:t("threePhase"),matchId:f.value,phase:"threePhase"},null,8,["isTimeValid","matchId"])])):B("",!0),d.value==="champion"?(_(),T("div",ba,[o("div",ya,[o("p",null,"竞猜时间："+P(V("champion")),1)]),C(Et,{ref_key:"championRef",ref:b,isTimeValid:t("champion"),matchId:f.value},null,8,["isTimeValid","matchId"])])):B("",!0)])])):(_(),T("div",ka,[C(F,{description:"暂无可用赛事"})]))]),C(Ot,{modelValue:q.value,"onUpdate:modelValue":n[4]||(n[4]=X=>q.value=X)},null,8,["modelValue"])])}}}),Ga=J(Pa,[["__scopeId","data-v-83497185"]]);export{Ga as default};
