import{E as C,a as E,b as V}from"./element-plus.C3kSHAgf.js";import{_ as h}from"./index.mpBZixX1.js";import{r as l,A as O,f as B,c as p,a as c,T as _,U as d,O as f,M as T,R as U,F as $,a8 as P,o as v,S,I as D}from"./@vue.kwc71ESp.js";import"./lodash-es.CiJSjksT.js";import"./@vueuse.Bmvu7DnR.js";import"./@element-plus.CQ2moJ0T.js";import"./@popperjs.D9SI2xQl.js";import"./@ctrl.r5W6hzzQ.js";import"./dayjs.CdCgAjqw.js";import"./async-validator.DKvM95Vc.js";import"./memoize-one.BdPwpGay.js";import"./normalize-wheel-es.B6fDCfyv.js";import"./@floating-ui.8uccrNCM.js";import"./axios.CCb-kr4I.js";import"./vue-router.DkBAQHKx.js";const F={id:"online-count"},J={id:"message-container"},z={__name:"test",setup(A){const t=l(null),g=l(Math.random().toString(36).substr(2)),o=l(""),n=l(""),a=l([]),b=l(0),m=l(!1);"WebSocket"in window?t.value=new WebSocket(`ws://localhost:9090/machine/ws/${g.value}`):alert("Not support websocket");const k=()=>{a.value.push({text:"error",isMine:!1})},I=()=>{!localStorage.getItem("userId")==""&&(m.value=!0,o.value=localStorage.getItem("userId")),a.value.push({text:"连接成功",isMine:!1})},M=r=>{try{const e=JSON.parse(r.data);if(e.type==="onlineCount")b.value=e.count;else if(e.type==="serverMessage")a.value.push({text:e.message,isMine:!1});else if(e.type==="clientMessage"){const u=e.userId===o.value,i=`${e.userId} ：${e.message}`;a.value.push({text:i,isMine:u})}else console.error("未知的消息类型:",e)}catch(e){console.error("解析消息失败:",r.data,e),a.value.push({text:"解析消息失败",isMine:!1})}},x=()=>{a.value.push({text:"连接已关闭",isMine:!1})},N=()=>{t.value&&t.value.readyState===WebSocket.OPEN&&(localStorage.setItem("userId",o.value),!localStorage.getItem("userId")==""&&!n.value==""?(m.value=!0,o.value=localStorage.getItem("userId"),t.value.send(JSON.stringify({type:"clientMessage",message:n.value,userId:o.value})),n.value=""):C.alert("请输入名字和内容","请输入名字和内容",{confirmButtonText:"OK"}))},y=()=>{t.value&&t.value.readyState===WebSocket.OPEN&&t.value.close()},W=()=>{(!t.value||t.value.readyState!==WebSocket.CONNECTING)&&(t.value=new WebSocket(`ws://localhost:9090/machine/ws/${g.value}`),t.value.onerror=k,t.value.onopen=I,t.value.onmessage=M,t.value.onclose=x)};return O(()=>{y()}),B(()=>{t.value&&(t.value.onerror=k,t.value.onopen=I,t.value.onmessage=M,t.value.onclose=x)}),(r,e)=>{const u=E,i=V;return v(),p("div",null,[c("div",F,[c("p",null,"当前在线人数: "+_(b.value),1)]),d(u,{onClick:y},{default:f(()=>e[2]||(e[2]=[S("关闭连接")])),_:1}),!t.value.value||t.value.value.readyState!==r.WebSocket.OPEN?(v(),T(u,{key:0,onClick:W},{default:f(()=>e[3]||(e[3]=[S("重新连接")])),_:1})):U("",!0),c("div",J,[(v(!0),p($,null,P(a.value,(s,w)=>(v(),p("div",{key:w,class:D({"message-bubble":!0,mine:s.isMine,others:!s.isMine})},[c("p",null,_(s.text),1)],2))),128))]),d(i,{id:"userId",type:"text",modelValue:o.value,"onUpdate:modelValue":e[0]||(e[0]=s=>o.value=s),disabled:m.value,placeholder:"请输入您的ID(你只能输入一次，请谨慎)"},null,8,["modelValue","disabled"]),d(i,{id:"text",type:"text",modelValue:n.value,"onUpdate:modelValue":e[1]||(e[1]=s=>n.value=s),placeholder:"请输入内容"},null,8,["modelValue"]),d(u,{onClick:N},{default:f(()=>e[4]||(e[4]=[S("发送消息")])),_:1})])}}},se=h(z,[["__scopeId","data-v-124f6a3a"]]);export{se as default};
