import{TrianglesDrawMode as He,TriangleFanDrawMode as le,TriangleStripDrawMode as Me,Loader as Ge,LoaderUtils as Q,FileLoader as we,MeshPhysicalMaterial as P,Vector2 as Se,Color as K,LinearSRGBColorSpace as k,SRGBColorSpace as J,SpotLight as Be,PointLight as Ue,DirectionalLight as ve,Matrix4 as ne,Vector3 as X,Quaternion as be,InstancedMesh as je,InstancedBufferAttribute as Ke,Object3D as Ie,TextureLoader as Ve,ImageBitmapLoader as Xe,BufferAttribute as te,InterleavedBuffer as ze,InterleavedBufferAttribute as qe,LinearMipmapLinearFilter as Ne,NearestMipmapLinearFilter as We,LinearMipmapNearestFilter as Ye,NearestMipmapNearestFilter as Qe,LinearFilter as $,NearestFilter as Oe,RepeatWrapping as ue,MirroredRepeatWrapping as Je,ClampToEdgeWrapping as $e,PointsMaterial as Ze,Material as se,LineBasicMaterial as en,MeshStandardMaterial as Ce,DoubleSide as nn,MeshBasicMaterial as Y,PropertyBinding as tn,BufferGeometry as sn,SkinnedMesh as rn,Mesh as on,LineSegments as an,Line as cn,LineLoop as ln,Points as un,Group as re,PerspectiveCamera as hn,MathUtils as fn,OrthographicCamera as dn,Skeleton as pn,AnimationClip as mn,Bone as gn,InterpolateDiscrete as Tn,InterpolateLinear as Fe,Texture as me,VectorKeyframeTrack as ge,NumberKeyframeTrack as Te,QuaternionKeyframeTrack as Re,ColorManagement as _e,FrontSide as Rn,Interpolant as _n,Box3 as En,Sphere as xn,DataTextureLoader as An,HalfFloatType as Z,FloatType as ie,DataUtils as ee}from"three";function Ee(h,n){if(n===He)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),h;if(n===le||n===Me){let e=h.getIndex();if(e===null){const s=[],a=h.getAttribute("position");if(a!==void 0){for(let o=0;o<a.count;o++)s.push(o);h.setIndex(s),e=h.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),h}const i=e.count-2,t=[];if(n===le)for(let s=1;s<=i;s++)t.push(e.getX(0)),t.push(e.getX(s)),t.push(e.getX(s+1));else for(let s=0;s<i;s++)s%2===0?(t.push(e.getX(s)),t.push(e.getX(s+1)),t.push(e.getX(s+2))):(t.push(e.getX(s+2)),t.push(e.getX(s+1)),t.push(e.getX(s)));t.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=h.clone();return r.setIndex(t),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",n),h}class rt extends Ge{constructor(n){super(n),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new Sn(e)}),this.register(function(e){return new bn(e)}),this.register(function(e){return new Hn(e)}),this.register(function(e){return new Gn(e)}),this.register(function(e){return new Bn(e)}),this.register(function(e){return new Nn(e)}),this.register(function(e){return new On(e)}),this.register(function(e){return new Cn(e)}),this.register(function(e){return new Fn(e)}),this.register(function(e){return new wn(e)}),this.register(function(e){return new Dn(e)}),this.register(function(e){return new In(e)}),this.register(function(e){return new Pn(e)}),this.register(function(e){return new kn(e)}),this.register(function(e){return new yn(e)}),this.register(function(e){return new Un(e)}),this.register(function(e){return new vn(e)})}load(n,e,i,t){const r=this;let s;if(this.resourcePath!=="")s=this.resourcePath;else if(this.path!==""){const c=Q.extractUrlBase(n);s=Q.resolveURL(c,this.path)}else s=Q.extractUrlBase(n);this.manager.itemStart(n);const a=function(c){t?t(c):console.error(c),r.manager.itemError(n),r.manager.itemEnd(n)},o=new we(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(n,function(c){try{r.parse(c,s,function(u){e(u),r.manager.itemEnd(n)},a)}catch(u){a(u)}},i,a)}setDRACOLoader(n){return this.dracoLoader=n,this}setKTX2Loader(n){return this.ktx2Loader=n,this}setMeshoptDecoder(n){return this.meshoptDecoder=n,this}register(n){return this.pluginCallbacks.indexOf(n)===-1&&this.pluginCallbacks.push(n),this}unregister(n){return this.pluginCallbacks.indexOf(n)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(n),1),this}parse(n,e,i,t){let r;const s={},a={},o=new TextDecoder;if(typeof n=="string")r=JSON.parse(n);else if(n instanceof ArrayBuffer)if(o.decode(new Uint8Array(n,0,4))===De){try{s[R.KHR_BINARY_GLTF]=new jn(n)}catch(l){t&&t(l);return}r=JSON.parse(s[R.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(n));else r=n;if(r.asset===void 0||r.asset.version[0]<2){t&&t(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new nt(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const l=this.pluginCallbacks[u](c);l.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[l.name]=l,s[l.name]=!0}if(r.extensionsUsed)for(let u=0;u<r.extensionsUsed.length;++u){const l=r.extensionsUsed[u],f=r.extensionsRequired||[];switch(l){case R.KHR_MATERIALS_UNLIT:s[l]=new Mn;break;case R.KHR_DRACO_MESH_COMPRESSION:s[l]=new Kn(r,this.dracoLoader);break;case R.KHR_TEXTURE_TRANSFORM:s[l]=new Vn;break;case R.KHR_MESH_QUANTIZATION:s[l]=new Xn;break;default:f.indexOf(l)>=0&&a[l]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+l+'".')}}c.setExtensions(s),c.setPlugins(a),c.parse(i,t)}parseAsync(n,e){const i=this;return new Promise(function(t,r){i.parse(n,e,t,r)})}}function Ln(){let h={};return{get:function(n){return h[n]},add:function(n,e){h[n]=e},remove:function(n){delete h[n]},removeAll:function(){h={}}}}const R={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class yn{constructor(n){this.parser=n,this.name=R.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const n=this.parser,e=this.parser.json.nodes||[];for(let i=0,t=e.length;i<t;i++){const r=e[i];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&n._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(n){const e=this.parser,i="light:"+n;let t=e.cache.get(i);if(t)return t;const r=e.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[n];let c;const u=new K(16777215);o.color!==void 0&&u.setRGB(o.color[0],o.color[1],o.color[2],k);const l=o.range!==void 0?o.range:0;switch(o.type){case"directional":c=new ve(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Ue(u),c.distance=l;break;case"spot":c=new Be(u),c.distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,c.angle=o.spot.outerConeAngle,c.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return c.position.set(0,0,0),U(c,o),o.intensity!==void 0&&(c.intensity=o.intensity),c.name=e.createUniqueName(o.name||"light_"+n),t=Promise.resolve(c),e.cache.add(i,t),t}getDependency(n,e){if(n==="light")return this._loadLight(e)}createNodeAttachment(n){const e=this,i=this.parser,r=i.json.nodes[n],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(o){return i._getNodeRef(e.cache,a,o)})}}class Mn{constructor(){this.name=R.KHR_MATERIALS_UNLIT}getMaterialType(){return Y}extendParams(n,e,i){const t=[];n.color=new K(1,1,1),n.opacity=1;const r=e.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const s=r.baseColorFactor;n.color.setRGB(s[0],s[1],s[2],k),n.opacity=s[3]}r.baseColorTexture!==void 0&&t.push(i.assignTexture(n,"map",r.baseColorTexture,J))}return Promise.all(t)}}class wn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(n,e){const t=this.parser.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=t.extensions[this.name].emissiveStrength;return r!==void 0&&(e.emissiveIntensity=r),Promise.resolve()}}class Sn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_CLEARCOAT}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];if(s.clearcoatFactor!==void 0&&(e.clearcoat=s.clearcoatFactor),s.clearcoatTexture!==void 0&&r.push(i.assignTexture(e,"clearcoatMap",s.clearcoatTexture)),s.clearcoatRoughnessFactor!==void 0&&(e.clearcoatRoughness=s.clearcoatRoughnessFactor),s.clearcoatRoughnessTexture!==void 0&&r.push(i.assignTexture(e,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),s.clearcoatNormalTexture!==void 0&&(r.push(i.assignTexture(e,"clearcoatNormalMap",s.clearcoatNormalTexture)),s.clearcoatNormalTexture.scale!==void 0)){const a=s.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new Se(a,a)}return Promise.all(r)}}class bn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_DISPERSION}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const t=this.parser.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=t.extensions[this.name];return e.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class In{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_IRIDESCENCE}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];return s.iridescenceFactor!==void 0&&(e.iridescence=s.iridescenceFactor),s.iridescenceTexture!==void 0&&r.push(i.assignTexture(e,"iridescenceMap",s.iridescenceTexture)),s.iridescenceIor!==void 0&&(e.iridescenceIOR=s.iridescenceIor),e.iridescenceThicknessRange===void 0&&(e.iridescenceThicknessRange=[100,400]),s.iridescenceThicknessMinimum!==void 0&&(e.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),s.iridescenceThicknessMaximum!==void 0&&(e.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),s.iridescenceThicknessTexture!==void 0&&r.push(i.assignTexture(e,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(r)}}class Nn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_SHEEN}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[];e.sheenColor=new K(0,0,0),e.sheenRoughness=0,e.sheen=1;const s=t.extensions[this.name];if(s.sheenColorFactor!==void 0){const a=s.sheenColorFactor;e.sheenColor.setRGB(a[0],a[1],a[2],k)}return s.sheenRoughnessFactor!==void 0&&(e.sheenRoughness=s.sheenRoughnessFactor),s.sheenColorTexture!==void 0&&r.push(i.assignTexture(e,"sheenColorMap",s.sheenColorTexture,J)),s.sheenRoughnessTexture!==void 0&&r.push(i.assignTexture(e,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(r)}}class On{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_TRANSMISSION}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];return s.transmissionFactor!==void 0&&(e.transmission=s.transmissionFactor),s.transmissionTexture!==void 0&&r.push(i.assignTexture(e,"transmissionMap",s.transmissionTexture)),Promise.all(r)}}class Cn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_VOLUME}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];e.thickness=s.thicknessFactor!==void 0?s.thicknessFactor:0,s.thicknessTexture!==void 0&&r.push(i.assignTexture(e,"thicknessMap",s.thicknessTexture)),e.attenuationDistance=s.attenuationDistance||1/0;const a=s.attenuationColor||[1,1,1];return e.attenuationColor=new K().setRGB(a[0],a[1],a[2],k),Promise.all(r)}}class Fn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_IOR}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const t=this.parser.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=t.extensions[this.name];return e.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class Dn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_SPECULAR}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];e.specularIntensity=s.specularFactor!==void 0?s.specularFactor:1,s.specularTexture!==void 0&&r.push(i.assignTexture(e,"specularIntensityMap",s.specularTexture));const a=s.specularColorFactor||[1,1,1];return e.specularColor=new K().setRGB(a[0],a[1],a[2],k),s.specularColorTexture!==void 0&&r.push(i.assignTexture(e,"specularColorMap",s.specularColorTexture,J)),Promise.all(r)}}class kn{constructor(n){this.parser=n,this.name=R.EXT_MATERIALS_BUMP}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];return e.bumpScale=s.bumpFactor!==void 0?s.bumpFactor:1,s.bumpTexture!==void 0&&r.push(i.assignTexture(e,"bumpMap",s.bumpTexture)),Promise.all(r)}}class Pn{constructor(n){this.parser=n,this.name=R.KHR_MATERIALS_ANISOTROPY}getMaterialType(n){const i=this.parser.json.materials[n];return!i.extensions||!i.extensions[this.name]?null:P}extendMaterialParams(n,e){const i=this.parser,t=i.json.materials[n];if(!t.extensions||!t.extensions[this.name])return Promise.resolve();const r=[],s=t.extensions[this.name];return s.anisotropyStrength!==void 0&&(e.anisotropy=s.anisotropyStrength),s.anisotropyRotation!==void 0&&(e.anisotropyRotation=s.anisotropyRotation),s.anisotropyTexture!==void 0&&r.push(i.assignTexture(e,"anisotropyMap",s.anisotropyTexture)),Promise.all(r)}}class Hn{constructor(n){this.parser=n,this.name=R.KHR_TEXTURE_BASISU}loadTexture(n){const e=this.parser,i=e.json,t=i.textures[n];if(!t.extensions||!t.extensions[this.name])return null;const r=t.extensions[this.name],s=e.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(n,r.source,s)}}class Gn{constructor(n){this.parser=n,this.name=R.EXT_TEXTURE_WEBP}loadTexture(n){const e=this.name,i=this.parser,t=i.json,r=t.textures[n];if(!r.extensions||!r.extensions[e])return null;const s=r.extensions[e],a=t.images[s.source];let o=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(o=c)}return i.loadTextureImage(n,s.source,o)}}class Bn{constructor(n){this.parser=n,this.name=R.EXT_TEXTURE_AVIF}loadTexture(n){const e=this.name,i=this.parser,t=i.json,r=t.textures[n];if(!r.extensions||!r.extensions[e])return null;const s=r.extensions[e],a=t.images[s.source];let o=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(o=c)}return i.loadTextureImage(n,s.source,o)}}class Un{constructor(n){this.name=R.EXT_MESHOPT_COMPRESSION,this.parser=n}loadBufferView(n){const e=this.parser.json,i=e.bufferViews[n];if(i.extensions&&i.extensions[this.name]){const t=i.extensions[this.name],r=this.parser.getDependency("buffer",t.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const o=t.byteOffset||0,c=t.byteLength||0,u=t.count,l=t.byteStride,f=new Uint8Array(a,o,c);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(u,l,f,t.mode,t.filter).then(function(d){return d.buffer}):s.ready.then(function(){const d=new ArrayBuffer(u*l);return s.decodeGltfBuffer(new Uint8Array(d),u,l,f,t.mode,t.filter),d})})}else return null}}class vn{constructor(n){this.name=R.EXT_MESH_GPU_INSTANCING,this.parser=n}createNodeMesh(n){const e=this.parser.json,i=e.nodes[n];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const t=e.meshes[i.mesh];for(const c of t.primitives)if(c.mode!==D.TRIANGLES&&c.mode!==D.TRIANGLE_STRIP&&c.mode!==D.TRIANGLE_FAN&&c.mode!==void 0)return null;const s=i.extensions[this.name].attributes,a=[],o={};for(const c in s)a.push(this.parser.getDependency("accessor",s[c]).then(u=>(o[c]=u,o[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(n)),Promise.all(a).then(c=>{const u=c.pop(),l=u.isGroup?u.children:[u],f=c[0].count,d=[];for(const g of l){const A=new ne,p=new X,T=new be,L=new X(1,1,1),b=new je(g.geometry,g.material,f);for(let E=0;E<f;E++)o.TRANSLATION&&p.fromBufferAttribute(o.TRANSLATION,E),o.ROTATION&&T.fromBufferAttribute(o.ROTATION,E),o.SCALE&&L.fromBufferAttribute(o.SCALE,E),b.setMatrixAt(E,A.compose(p,T,L));for(const E in o)if(E==="_COLOR_0"){const C=o[E];b.instanceColor=new Ke(C.array,C.itemSize,C.normalized)}else E!=="TRANSLATION"&&E!=="ROTATION"&&E!=="SCALE"&&g.geometry.setAttribute(E,o[E]);Ie.prototype.copy.call(b,g),this.parser.assignFinalMaterial(b),d.push(b)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const De="glTF",W=12,xe={JSON:1313821514,BIN:5130562};class jn{constructor(n){this.name=R.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(n,0,W),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(n.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==De)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const t=this.header.length-W,r=new DataView(n,W);let s=0;for(;s<t;){const a=r.getUint32(s,!0);s+=4;const o=r.getUint32(s,!0);if(s+=4,o===xe.JSON){const c=new Uint8Array(n,W+s,a);this.content=i.decode(c)}else if(o===xe.BIN){const c=W+s;this.body=n.slice(c,c+a)}s+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Kn{constructor(n,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=R.KHR_DRACO_MESH_COMPRESSION,this.json=n,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(n,e){const i=this.json,t=this.dracoLoader,r=n.extensions[this.name].bufferView,s=n.extensions[this.name].attributes,a={},o={},c={};for(const u in s){const l=he[u]||u.toLowerCase();a[l]=s[u]}for(const u in n.attributes){const l=he[u]||u.toLowerCase();if(s[u]!==void 0){const f=i.accessors[n.attributes[u]],d=z[f.componentType];c[l]=d.name,o[l]=f.normalized===!0}}return e.getDependency("bufferView",r).then(function(u){return new Promise(function(l,f){t.decodeDracoFile(u,function(d){for(const g in d.attributes){const A=d.attributes[g],p=o[g];p!==void 0&&(A.normalized=p)}l(d)},a,c,k,f)})})}}class Vn{constructor(){this.name=R.KHR_TEXTURE_TRANSFORM}extendTexture(n,e){return(e.texCoord===void 0||e.texCoord===n.channel)&&e.offset===void 0&&e.rotation===void 0&&e.scale===void 0||(n=n.clone(),e.texCoord!==void 0&&(n.channel=e.texCoord),e.offset!==void 0&&n.offset.fromArray(e.offset),e.rotation!==void 0&&(n.rotation=e.rotation),e.scale!==void 0&&n.repeat.fromArray(e.scale),n.needsUpdate=!0),n}}class Xn{constructor(){this.name=R.KHR_MESH_QUANTIZATION}}class ke extends _n{constructor(n,e,i,t){super(n,e,i,t)}copySampleValue_(n){const e=this.resultBuffer,i=this.sampleValues,t=this.valueSize,r=n*t*3+t;for(let s=0;s!==t;s++)e[s]=i[r+s];return e}interpolate_(n,e,i,t){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=a*2,c=a*3,u=t-e,l=(i-e)/u,f=l*l,d=f*l,g=n*c,A=g-c,p=-2*d+3*f,T=d-f,L=1-p,b=T-f+l;for(let E=0;E!==a;E++){const C=s[A+E+a],F=s[A+E+o]*u,O=s[g+E+a],m=s[g+E]*u;r[E]=L*C+b*F+p*O+T*m}return r}}const zn=new be;class qn extends ke{interpolate_(n,e,i,t){const r=super.interpolate_(n,e,i,t);return zn.fromArray(r).normalize().toArray(r),r}}const D={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},z={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ae={9728:Oe,9729:$,9984:Qe,9985:Ye,9986:We,9987:Ne},Le={33071:$e,33648:Je,10497:ue},oe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},he={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},v={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Wn={CUBICSPLINE:void 0,LINEAR:Fe,STEP:Tn},ae={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Yn(h){return h.DefaultMaterial===void 0&&(h.DefaultMaterial=new Ce({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Rn})),h.DefaultMaterial}function j(h,n,e){for(const i in e.extensions)h[i]===void 0&&(n.userData.gltfExtensions=n.userData.gltfExtensions||{},n.userData.gltfExtensions[i]=e.extensions[i])}function U(h,n){n.extras!==void 0&&(typeof n.extras=="object"?Object.assign(h.userData,n.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+n.extras))}function Qn(h,n,e){let i=!1,t=!1,r=!1;for(let c=0,u=n.length;c<u;c++){const l=n[c];if(l.POSITION!==void 0&&(i=!0),l.NORMAL!==void 0&&(t=!0),l.COLOR_0!==void 0&&(r=!0),i&&t&&r)break}if(!i&&!t&&!r)return Promise.resolve(h);const s=[],a=[],o=[];for(let c=0,u=n.length;c<u;c++){const l=n[c];if(i){const f=l.POSITION!==void 0?e.getDependency("accessor",l.POSITION):h.attributes.position;s.push(f)}if(t){const f=l.NORMAL!==void 0?e.getDependency("accessor",l.NORMAL):h.attributes.normal;a.push(f)}if(r){const f=l.COLOR_0!==void 0?e.getDependency("accessor",l.COLOR_0):h.attributes.color;o.push(f)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o)]).then(function(c){const u=c[0],l=c[1],f=c[2];return i&&(h.morphAttributes.position=u),t&&(h.morphAttributes.normal=l),r&&(h.morphAttributes.color=f),h.morphTargetsRelative=!0,h})}function Jn(h,n){if(h.updateMorphTargets(),n.weights!==void 0)for(let e=0,i=n.weights.length;e<i;e++)h.morphTargetInfluences[e]=n.weights[e];if(n.extras&&Array.isArray(n.extras.targetNames)){const e=n.extras.targetNames;if(h.morphTargetInfluences.length===e.length){h.morphTargetDictionary={};for(let i=0,t=e.length;i<t;i++)h.morphTargetDictionary[e[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function $n(h){let n;const e=h.extensions&&h.extensions[R.KHR_DRACO_MESH_COMPRESSION];if(e?n="draco:"+e.bufferView+":"+e.indices+":"+ce(e.attributes):n=h.indices+":"+ce(h.attributes)+":"+h.mode,h.targets!==void 0)for(let i=0,t=h.targets.length;i<t;i++)n+=":"+ce(h.targets[i]);return n}function ce(h){let n="";const e=Object.keys(h).sort();for(let i=0,t=e.length;i<t;i++)n+=e[i]+":"+h[e[i]]+";";return n}function fe(h){switch(h){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Zn(h){return h.search(/\.jpe?g($|\?)/i)>0||h.search(/^data\:image\/jpeg/)===0?"image/jpeg":h.search(/\.webp($|\?)/i)>0||h.search(/^data\:image\/webp/)===0?"image/webp":h.search(/\.ktx2($|\?)/i)>0||h.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const et=new ne;class nt{constructor(n={},e={}){this.json=n,this.extensions={},this.plugins={},this.options=e,this.cache=new Ln,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,t=-1,r=!1,s=-1;if(typeof navigator<"u"){const a=navigator.userAgent;i=/^((?!chrome|android).)*safari/i.test(a)===!0;const o=a.match(/Version\/(\d+)/);t=i&&o?parseInt(o[1],10):-1,r=a.indexOf("Firefox")>-1,s=r?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||i&&t<17||r&&s<98?this.textureLoader=new Ve(this.options.manager):this.textureLoader=new Xe(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new we(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(n){this.extensions=n}setPlugins(n){this.plugins=n}parse(n,e){const i=this,t=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(s){return s._markDefs&&s._markDefs()}),Promise.all(this._invokeAll(function(s){return s.beforeRoot&&s.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(s){const a={scene:s[0][t.scene||0],scenes:s[0],animations:s[1],cameras:s[2],asset:t.asset,parser:i,userData:{}};return j(r,a,t),U(a,t),Promise.all(i._invokeAll(function(o){return o.afterRoot&&o.afterRoot(a)})).then(function(){for(const o of a.scenes)o.updateMatrixWorld();n(a)})}).catch(e)}_markDefs(){const n=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[];for(let t=0,r=e.length;t<r;t++){const s=e[t].joints;for(let a=0,o=s.length;a<o;a++)n[s[a]].isBone=!0}for(let t=0,r=n.length;t<r;t++){const s=n[t];s.mesh!==void 0&&(this._addNodeRef(this.meshCache,s.mesh),s.skin!==void 0&&(i[s.mesh].isSkinnedMesh=!0)),s.camera!==void 0&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(n,e){e!==void 0&&(n.refs[e]===void 0&&(n.refs[e]=n.uses[e]=0),n.refs[e]++)}_getNodeRef(n,e,i){if(n.refs[e]<=1)return i;const t=i.clone(),r=(s,a)=>{const o=this.associations.get(s);o!=null&&this.associations.set(a,o);for(const[c,u]of s.children.entries())r(u,a.children[c])};return r(i,t),t.name+="_instance_"+n.uses[e]++,t}_invokeOne(n){const e=Object.values(this.plugins);e.push(this);for(let i=0;i<e.length;i++){const t=n(e[i]);if(t)return t}return null}_invokeAll(n){const e=Object.values(this.plugins);e.unshift(this);const i=[];for(let t=0;t<e.length;t++){const r=n(e[t]);r&&i.push(r)}return i}getDependency(n,e){const i=n+":"+e;let t=this.cache.get(i);if(!t){switch(n){case"scene":t=this.loadScene(e);break;case"node":t=this._invokeOne(function(r){return r.loadNode&&r.loadNode(e)});break;case"mesh":t=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(e)});break;case"accessor":t=this.loadAccessor(e);break;case"bufferView":t=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(e)});break;case"buffer":t=this.loadBuffer(e);break;case"material":t=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(e)});break;case"texture":t=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(e)});break;case"skin":t=this.loadSkin(e);break;case"animation":t=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(e)});break;case"camera":t=this.loadCamera(e);break;default:if(t=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(n,e)}),!t)throw new Error("Unknown type: "+n);break}this.cache.add(i,t)}return t}getDependencies(n){let e=this.cache.get(n);if(!e){const i=this,t=this.json[n+(n==="mesh"?"es":"s")]||[];e=Promise.all(t.map(function(r,s){return i.getDependency(n,s)})),this.cache.add(n,e)}return e}loadBuffer(n){const e=this.json.buffers[n],i=this.fileLoader;if(e.type&&e.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(e.uri===void 0&&n===0)return Promise.resolve(this.extensions[R.KHR_BINARY_GLTF].body);const t=this.options;return new Promise(function(r,s){i.load(Q.resolveURL(e.uri,t.path),r,void 0,function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))})})}loadBufferView(n){const e=this.json.bufferViews[n];return this.getDependency("buffer",e.buffer).then(function(i){const t=e.byteLength||0,r=e.byteOffset||0;return i.slice(r,r+t)})}loadAccessor(n){const e=this,i=this.json,t=this.json.accessors[n];if(t.bufferView===void 0&&t.sparse===void 0){const s=oe[t.type],a=z[t.componentType],o=t.normalized===!0,c=new a(t.count*s);return Promise.resolve(new te(c,s,o))}const r=[];return t.bufferView!==void 0?r.push(this.getDependency("bufferView",t.bufferView)):r.push(null),t.sparse!==void 0&&(r.push(this.getDependency("bufferView",t.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",t.sparse.values.bufferView))),Promise.all(r).then(function(s){const a=s[0],o=oe[t.type],c=z[t.componentType],u=c.BYTES_PER_ELEMENT,l=u*o,f=t.byteOffset||0,d=t.bufferView!==void 0?i.bufferViews[t.bufferView].byteStride:void 0,g=t.normalized===!0;let A,p;if(d&&d!==l){const T=Math.floor(f/d),L="InterleavedBuffer:"+t.bufferView+":"+t.componentType+":"+T+":"+t.count;let b=e.cache.get(L);b||(A=new c(a,T*d,t.count*d/u),b=new ze(A,d/u),e.cache.add(L,b)),p=new qe(b,o,f%d/u,g)}else a===null?A=new c(t.count*o):A=new c(a,f,t.count*o),p=new te(A,o,g);if(t.sparse!==void 0){const T=oe.SCALAR,L=z[t.sparse.indices.componentType],b=t.sparse.indices.byteOffset||0,E=t.sparse.values.byteOffset||0,C=new L(s[1],b,t.sparse.count*T),F=new c(s[2],E,t.sparse.count*o);a!==null&&(p=new te(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let O=0,m=C.length;O<m;O++){const _=C[O];if(p.setX(_,F[O*o]),o>=2&&p.setY(_,F[O*o+1]),o>=3&&p.setZ(_,F[O*o+2]),o>=4&&p.setW(_,F[O*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=g}return p})}loadTexture(n){const e=this.json,i=this.options,r=e.textures[n].source,s=e.images[r];let a=this.textureLoader;if(s.uri){const o=i.manager.getHandler(s.uri);o!==null&&(a=o)}return this.loadTextureImage(n,r,a)}loadTextureImage(n,e,i){const t=this,r=this.json,s=r.textures[n],a=r.images[e],o=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[o])return this.textureCache[o];const c=this.loadImageSource(e,i).then(function(u){u.flipY=!1,u.name=s.name||a.name||"",u.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(u.name=a.uri);const f=(r.samplers||{})[s.sampler]||{};return u.magFilter=Ae[f.magFilter]||$,u.minFilter=Ae[f.minFilter]||Ne,u.wrapS=Le[f.wrapS]||ue,u.wrapT=Le[f.wrapT]||ue,u.generateMipmaps=!u.isCompressedTexture&&u.minFilter!==Oe&&u.minFilter!==$,t.associations.set(u,{textures:n}),u}).catch(function(){return null});return this.textureCache[o]=c,c}loadImageSource(n,e){const i=this,t=this.json,r=this.options;if(this.sourceCache[n]!==void 0)return this.sourceCache[n].then(l=>l.clone());const s=t.images[n],a=self.URL||self.webkitURL;let o=s.uri||"",c=!1;if(s.bufferView!==void 0)o=i.getDependency("bufferView",s.bufferView).then(function(l){c=!0;const f=new Blob([l],{type:s.mimeType});return o=a.createObjectURL(f),o});else if(s.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+n+" is missing URI and bufferView");const u=Promise.resolve(o).then(function(l){return new Promise(function(f,d){let g=f;e.isImageBitmapLoader===!0&&(g=function(A){const p=new me(A);p.needsUpdate=!0,f(p)}),e.load(Q.resolveURL(l,r.path),g,void 0,d)})}).then(function(l){return c===!0&&a.revokeObjectURL(o),U(l,s),l.userData.mimeType=s.mimeType||Zn(s.uri),l}).catch(function(l){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),l});return this.sourceCache[n]=u,u}assignTexture(n,e,i,t){const r=this;return this.getDependency("texture",i.index).then(function(s){if(!s)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(s=s.clone(),s.channel=i.texCoord),r.extensions[R.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[R.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const o=r.associations.get(s);s=r.extensions[R.KHR_TEXTURE_TRANSFORM].extendTexture(s,a),r.associations.set(s,o)}}return t!==void 0&&(s.colorSpace=t),n[e]=s,s})}assignFinalMaterial(n){const e=n.geometry;let i=n.material;const t=e.attributes.tangent===void 0,r=e.attributes.color!==void 0,s=e.attributes.normal===void 0;if(n.isPoints){const a="PointsMaterial:"+i.uuid;let o=this.cache.get(a);o||(o=new Ze,se.prototype.copy.call(o,i),o.color.copy(i.color),o.map=i.map,o.sizeAttenuation=!1,this.cache.add(a,o)),i=o}else if(n.isLine){const a="LineBasicMaterial:"+i.uuid;let o=this.cache.get(a);o||(o=new en,se.prototype.copy.call(o,i),o.color.copy(i.color),o.map=i.map,this.cache.add(a,o)),i=o}if(t||r||s){let a="ClonedMaterial:"+i.uuid+":";t&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),s&&(a+="flat-shading:");let o=this.cache.get(a);o||(o=i.clone(),r&&(o.vertexColors=!0),s&&(o.flatShading=!0),t&&(o.normalScale&&(o.normalScale.y*=-1),o.clearcoatNormalScale&&(o.clearcoatNormalScale.y*=-1)),this.cache.add(a,o),this.associations.set(o,this.associations.get(i))),i=o}n.material=i}getMaterialType(){return Ce}loadMaterial(n){const e=this,i=this.json,t=this.extensions,r=i.materials[n];let s;const a={},o=r.extensions||{},c=[];if(o[R.KHR_MATERIALS_UNLIT]){const l=t[R.KHR_MATERIALS_UNLIT];s=l.getMaterialType(),c.push(l.extendParams(a,r,e))}else{const l=r.pbrMetallicRoughness||{};if(a.color=new K(1,1,1),a.opacity=1,Array.isArray(l.baseColorFactor)){const f=l.baseColorFactor;a.color.setRGB(f[0],f[1],f[2],k),a.opacity=f[3]}l.baseColorTexture!==void 0&&c.push(e.assignTexture(a,"map",l.baseColorTexture,J)),a.metalness=l.metallicFactor!==void 0?l.metallicFactor:1,a.roughness=l.roughnessFactor!==void 0?l.roughnessFactor:1,l.metallicRoughnessTexture!==void 0&&(c.push(e.assignTexture(a,"metalnessMap",l.metallicRoughnessTexture)),c.push(e.assignTexture(a,"roughnessMap",l.metallicRoughnessTexture))),s=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(n)}),c.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(n,a)})))}r.doubleSided===!0&&(a.side=nn);const u=r.alphaMode||ae.OPAQUE;if(u===ae.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===ae.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&s!==Y&&(c.push(e.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new Se(1,1),r.normalTexture.scale!==void 0)){const l=r.normalTexture.scale;a.normalScale.set(l,l)}if(r.occlusionTexture!==void 0&&s!==Y&&(c.push(e.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&s!==Y){const l=r.emissiveFactor;a.emissive=new K().setRGB(l[0],l[1],l[2],k)}return r.emissiveTexture!==void 0&&s!==Y&&c.push(e.assignTexture(a,"emissiveMap",r.emissiveTexture,J)),Promise.all(c).then(function(){const l=new s(a);return r.name&&(l.name=r.name),U(l,r),e.associations.set(l,{materials:n}),r.extensions&&j(t,l,r),l})}createUniqueName(n){const e=tn.sanitizeNodeName(n||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(n){const e=this,i=this.extensions,t=this.primitiveCache;function r(a){return i[R.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,e).then(function(o){return ye(o,a,e)})}const s=[];for(let a=0,o=n.length;a<o;a++){const c=n[a],u=$n(c),l=t[u];if(l)s.push(l.promise);else{let f;c.extensions&&c.extensions[R.KHR_DRACO_MESH_COMPRESSION]?f=r(c):f=ye(new sn,c,e),t[u]={primitive:c,promise:f},s.push(f)}}return Promise.all(s)}loadMesh(n){const e=this,i=this.json,t=this.extensions,r=i.meshes[n],s=r.primitives,a=[];for(let o=0,c=s.length;o<c;o++){const u=s[o].material===void 0?Yn(this.cache):this.getDependency("material",s[o].material);a.push(u)}return a.push(e.loadGeometries(s)),Promise.all(a).then(function(o){const c=o.slice(0,o.length-1),u=o[o.length-1],l=[];for(let d=0,g=u.length;d<g;d++){const A=u[d],p=s[d];let T;const L=c[d];if(p.mode===D.TRIANGLES||p.mode===D.TRIANGLE_STRIP||p.mode===D.TRIANGLE_FAN||p.mode===void 0)T=r.isSkinnedMesh===!0?new rn(A,L):new on(A,L),T.isSkinnedMesh===!0&&T.normalizeSkinWeights(),p.mode===D.TRIANGLE_STRIP?T.geometry=Ee(T.geometry,Me):p.mode===D.TRIANGLE_FAN&&(T.geometry=Ee(T.geometry,le));else if(p.mode===D.LINES)T=new an(A,L);else if(p.mode===D.LINE_STRIP)T=new cn(A,L);else if(p.mode===D.LINE_LOOP)T=new ln(A,L);else if(p.mode===D.POINTS)T=new un(A,L);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(T.geometry.morphAttributes).length>0&&Jn(T,r),T.name=e.createUniqueName(r.name||"mesh_"+n),U(T,r),p.extensions&&j(t,T,p),e.assignFinalMaterial(T),l.push(T)}for(let d=0,g=l.length;d<g;d++)e.associations.set(l[d],{meshes:n,primitives:d});if(l.length===1)return r.extensions&&j(t,l[0],r),l[0];const f=new re;r.extensions&&j(t,f,r),e.associations.set(f,{meshes:n});for(let d=0,g=l.length;d<g;d++)f.add(l[d]);return f})}loadCamera(n){let e;const i=this.json.cameras[n],t=i[i.type];if(!t){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?e=new hn(fn.radToDeg(t.yfov),t.aspectRatio||1,t.znear||1,t.zfar||2e6):i.type==="orthographic"&&(e=new dn(-t.xmag,t.xmag,t.ymag,-t.ymag,t.znear,t.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),U(e,i),Promise.resolve(e)}loadSkin(n){const e=this.json.skins[n],i=[];for(let t=0,r=e.joints.length;t<r;t++)i.push(this._loadNodeShallow(e.joints[t]));return e.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",e.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(t){const r=t.pop(),s=t,a=[],o=[];for(let c=0,u=s.length;c<u;c++){const l=s[c];if(l){a.push(l);const f=new ne;r!==null&&f.fromArray(r.array,c*16),o.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[c])}return new pn(a,o)})}loadAnimation(n){const e=this.json,i=this,t=e.animations[n],r=t.name?t.name:"animation_"+n,s=[],a=[],o=[],c=[],u=[];for(let l=0,f=t.channels.length;l<f;l++){const d=t.channels[l],g=t.samplers[d.sampler],A=d.target,p=A.node,T=t.parameters!==void 0?t.parameters[g.input]:g.input,L=t.parameters!==void 0?t.parameters[g.output]:g.output;A.node!==void 0&&(s.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",T)),o.push(this.getDependency("accessor",L)),c.push(g),u.push(A))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o),Promise.all(c),Promise.all(u)]).then(function(l){const f=l[0],d=l[1],g=l[2],A=l[3],p=l[4],T=[];for(let L=0,b=f.length;L<b;L++){const E=f[L],C=d[L],F=g[L],O=A[L],m=p[L];if(E===void 0)continue;E.updateMatrix&&E.updateMatrix();const _=i._createAnimationTracks(E,C,F,O,m);if(_)for(let y=0;y<_.length;y++)T.push(_[y])}return new mn(r,void 0,T)})}createNodeMesh(n){const e=this.json,i=this,t=e.nodes[n];return t.mesh===void 0?null:i.getDependency("mesh",t.mesh).then(function(r){const s=i._getNodeRef(i.meshCache,t.mesh,r);return t.weights!==void 0&&s.traverse(function(a){if(a.isMesh)for(let o=0,c=t.weights.length;o<c;o++)a.morphTargetInfluences[o]=t.weights[o]}),s})}loadNode(n){const e=this.json,i=this,t=e.nodes[n],r=i._loadNodeShallow(n),s=[],a=t.children||[];for(let c=0,u=a.length;c<u;c++)s.push(i.getDependency("node",a[c]));const o=t.skin===void 0?Promise.resolve(null):i.getDependency("skin",t.skin);return Promise.all([r,Promise.all(s),o]).then(function(c){const u=c[0],l=c[1],f=c[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,et)});for(let d=0,g=l.length;d<g;d++)u.add(l[d]);return u})}_loadNodeShallow(n){const e=this.json,i=this.extensions,t=this;if(this.nodeCache[n]!==void 0)return this.nodeCache[n];const r=e.nodes[n],s=r.name?t.createUniqueName(r.name):"",a=[],o=t._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(n)});return o&&a.push(o),r.camera!==void 0&&a.push(t.getDependency("camera",r.camera).then(function(c){return t._getNodeRef(t.cameraCache,r.camera,c)})),t._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(n)}).forEach(function(c){a.push(c)}),this.nodeCache[n]=Promise.all(a).then(function(c){let u;if(r.isBone===!0?u=new gn:c.length>1?u=new re:c.length===1?u=c[0]:u=new Ie,u!==c[0])for(let l=0,f=c.length;l<f;l++)u.add(c[l]);if(r.name&&(u.userData.name=r.name,u.name=s),U(u,r),r.extensions&&j(i,u,r),r.matrix!==void 0){const l=new ne;l.fromArray(r.matrix),u.applyMatrix4(l)}else r.translation!==void 0&&u.position.fromArray(r.translation),r.rotation!==void 0&&u.quaternion.fromArray(r.rotation),r.scale!==void 0&&u.scale.fromArray(r.scale);if(!t.associations.has(u))t.associations.set(u,{});else if(r.mesh!==void 0&&t.meshCache.refs[r.mesh]>1){const l=t.associations.get(u);t.associations.set(u,{...l})}return t.associations.get(u).nodes=n,u}),this.nodeCache[n]}loadScene(n){const e=this.extensions,i=this.json.scenes[n],t=this,r=new re;i.name&&(r.name=t.createUniqueName(i.name)),U(r,i),i.extensions&&j(e,r,i);const s=i.nodes||[],a=[];for(let o=0,c=s.length;o<c;o++)a.push(t.getDependency("node",s[o]));return Promise.all(a).then(function(o){for(let u=0,l=o.length;u<l;u++)r.add(o[u]);const c=u=>{const l=new Map;for(const[f,d]of t.associations)(f instanceof se||f instanceof me)&&l.set(f,d);return u.traverse(f=>{const d=t.associations.get(f);d!=null&&l.set(f,d)}),l};return t.associations=c(r),r})}_createAnimationTracks(n,e,i,t,r){const s=[],a=n.name?n.name:n.uuid,o=[];v[r.path]===v.weights?n.traverse(function(f){f.morphTargetInfluences&&o.push(f.name?f.name:f.uuid)}):o.push(a);let c;switch(v[r.path]){case v.weights:c=Te;break;case v.rotation:c=Re;break;case v.translation:case v.scale:c=ge;break;default:switch(i.itemSize){case 1:c=Te;break;case 2:case 3:default:c=ge;break}break}const u=t.interpolation!==void 0?Wn[t.interpolation]:Fe,l=this._getArrayFromAccessor(i);for(let f=0,d=o.length;f<d;f++){const g=new c(o[f]+"."+v[r.path],e.array,l,u);t.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(g),s.push(g)}return s}_getArrayFromAccessor(n){let e=n.array;if(n.normalized){const i=fe(e.constructor),t=new Float32Array(e.length);for(let r=0,s=e.length;r<s;r++)t[r]=e[r]*i;e=t}return e}_createCubicSplineTrackInterpolant(n){n.createInterpolant=function(i){const t=this instanceof Re?qn:ke;return new t(this.times,this.values,this.getValueSize()/3,i)},n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function tt(h,n,e){const i=n.attributes,t=new En;if(i.POSITION!==void 0){const a=e.json.accessors[i.POSITION],o=a.min,c=a.max;if(o!==void 0&&c!==void 0){if(t.set(new X(o[0],o[1],o[2]),new X(c[0],c[1],c[2])),a.normalized){const u=fe(z[a.componentType]);t.min.multiplyScalar(u),t.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=n.targets;if(r!==void 0){const a=new X,o=new X;for(let c=0,u=r.length;c<u;c++){const l=r[c];if(l.POSITION!==void 0){const f=e.json.accessors[l.POSITION],d=f.min,g=f.max;if(d!==void 0&&g!==void 0){if(o.setX(Math.max(Math.abs(d[0]),Math.abs(g[0]))),o.setY(Math.max(Math.abs(d[1]),Math.abs(g[1]))),o.setZ(Math.max(Math.abs(d[2]),Math.abs(g[2]))),f.normalized){const A=fe(z[f.componentType]);o.multiplyScalar(A)}a.max(o)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}t.expandByVector(a)}h.boundingBox=t;const s=new xn;t.getCenter(s.center),s.radius=t.min.distanceTo(t.max)/2,h.boundingSphere=s}function ye(h,n,e){const i=n.attributes,t=[];function r(s,a){return e.getDependency("accessor",s).then(function(o){h.setAttribute(a,o)})}for(const s in i){const a=he[s]||s.toLowerCase();a in h.attributes||t.push(r(i[s],a))}if(n.indices!==void 0&&!h.index){const s=e.getDependency("accessor",n.indices).then(function(a){h.setIndex(a)});t.push(s)}return _e.workingColorSpace!==k&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${_e.workingColorSpace}" not supported.`),U(h,n),tt(h,n,e),Promise.all(t).then(function(){return n.targets!==void 0?Qn(h,n.targets,e):h})}class it extends An{constructor(n){super(n),this.type=Z}parse(n){const s=function(m,_){switch(m){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(_||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(_||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(_||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(_||""))}},u=`
`,l=function(m,_,y){_=_||1024;let I=m.pos,S=-1,x=0,N="",M=String.fromCharCode.apply(null,new Uint16Array(m.subarray(I,I+128)));for(;0>(S=M.indexOf(u))&&x<_&&I<m.byteLength;)N+=M,x+=M.length,I+=128,M+=String.fromCharCode.apply(null,new Uint16Array(m.subarray(I,I+128)));return-1<S?(m.pos+=x+S+1,N+M.slice(0,S)):!1},f=function(m){const _=/^#\?(\S+)/,y=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,w=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,I=/^\s*FORMAT=(\S+)\s*$/,S=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,x={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let N,M;for((m.pos>=m.byteLength||!(N=l(m)))&&s(1,"no header found"),(M=N.match(_))||s(3,"bad initial token"),x.valid|=1,x.programtype=M[1],x.string+=N+`
`;N=l(m),N!==!1;){if(x.string+=N+`
`,N.charAt(0)==="#"){x.comments+=N+`
`;continue}if((M=N.match(y))&&(x.gamma=parseFloat(M[1])),(M=N.match(w))&&(x.exposure=parseFloat(M[1])),(M=N.match(I))&&(x.valid|=2,x.format=M[1]),(M=N.match(S))&&(x.valid|=4,x.height=parseInt(M[1],10),x.width=parseInt(M[2],10)),x.valid&2&&x.valid&4)break}return x.valid&2||s(3,"missing format specifier"),x.valid&4||s(3,"missing image size specifier"),x},d=function(m,_,y){const w=_;if(w<8||w>32767||m[0]!==2||m[1]!==2||m[2]&128)return new Uint8Array(m);w!==(m[2]<<8|m[3])&&s(3,"wrong scanline width");const I=new Uint8Array(4*_*y);I.length||s(4,"unable to allocate buffer space");let S=0,x=0;const N=4*w,M=new Uint8Array(4),V=new Uint8Array(N);let de=y;for(;de>0&&x<m.byteLength;){x+4>m.byteLength&&s(1),M[0]=m[x++],M[1]=m[x++],M[2]=m[x++],M[3]=m[x++],(M[0]!=2||M[1]!=2||(M[2]<<8|M[3])!=w)&&s(3,"bad rgbe scanline format");let q=0,H;for(;q<N&&x<m.byteLength;){H=m[x++];const G=H>128;if(G&&(H-=128),(H===0||q+H>N)&&s(3,"bad scanline data"),G){const B=m[x++];for(let pe=0;pe<H;pe++)V[q++]=B}else V.set(m.subarray(x,x+H),q),q+=H,x+=H}const Pe=w;for(let G=0;G<Pe;G++){let B=0;I[S]=V[G+B],B+=w,I[S+1]=V[G+B],B+=w,I[S+2]=V[G+B],B+=w,I[S+3]=V[G+B],S+=4}de--}return I},g=function(m,_,y,w){const I=m[_+3],S=Math.pow(2,I-128)/255;y[w+0]=m[_+0]*S,y[w+1]=m[_+1]*S,y[w+2]=m[_+2]*S,y[w+3]=1},A=function(m,_,y,w){const I=m[_+3],S=Math.pow(2,I-128)/255;y[w+0]=ee.toHalfFloat(Math.min(m[_+0]*S,65504)),y[w+1]=ee.toHalfFloat(Math.min(m[_+1]*S,65504)),y[w+2]=ee.toHalfFloat(Math.min(m[_+2]*S,65504)),y[w+3]=ee.toHalfFloat(1)},p=new Uint8Array(n);p.pos=0;const T=f(p),L=T.width,b=T.height,E=d(p.subarray(p.pos),L,b);let C,F,O;switch(this.type){case ie:O=E.length/4;const m=new Float32Array(O*4);for(let y=0;y<O;y++)g(E,y*4,m,y*4);C=m,F=ie;break;case Z:O=E.length/4;const _=new Uint16Array(O*4);for(let y=0;y<O;y++)A(E,y*4,_,y*4);C=_,F=Z;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:L,height:b,data:C,header:T.string,gamma:T.gamma,exposure:T.exposure,type:F}}setDataType(n){return this.type=n,this}load(n,e,i,t){function r(s,a){switch(s.type){case ie:case Z:s.colorSpace=k,s.minFilter=$,s.magFilter=$,s.generateMipmaps=!1,s.flipY=!0;break}e&&e(s,a)}return super.load(n,r,i,t)}}export{rt as G,it as R};
