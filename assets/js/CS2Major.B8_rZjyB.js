import{d as q,h as p,j as Q,c as T,o as _,a as o,R as C,u as O,J as M,E as B,P,Q as le,a6 as de,W as ne,n as he,i as te,f as ae,al as G,ar as pe,K as fe,O as N,L as R,X as ge,I as we,U as Te}from"./@vue.BltuATdo.js";import{d as K}from"./vuedraggable.ChYD-0tc.js";import{_ as X,h as Z,u as _e}from"./index.w3WHUe5w.js";import{a as x,e as be}from"./element-plus.CmMYYrHJ.js";import{u as ye}from"./vue-router.oDprkwHL.js";import{U as ke,v as Pe}from"./@element-plus.D0bpsst8.js";import{h as Ce}from"./html2canvas.BfYXEYrK.js";import{S as $e,P as Ie,W as Se,A as Me,O as Ve,a as Le,D as me,b as De,c as xe,R as Ee,G as Ae,M as Re,B as ze,V as ve}from"./three.BX7nTO8R.js";import"./dayjs.BKG3DVjA.js";import"./vue.BGAqhlGm.js";import"./sortablejs.BNc-_XO6.js";import"./pinia.DfSVr1RC.js";import"./axios.ngrFHoWO.js";import"./js-cookie.Cz0CWeBA.js";import"./lodash-es.CDeyng3v.js";import"./@vueuse.7i1SIcsD.js";import"./@popperjs.D_chPuIy.js";import"./@ctrl.r5W6hzzQ.js";import"./async-validator.9PlIezaS.js";import"./memoize-one.BdPwpGay.js";import"./normalize-wheel-es.BQoi3Ox2.js";import"./@floating-ui.D0iZPv2f.js";const Be={class:"major-predict-root"},Ue={class:"team-pool"},Fe=["src","alt"],je={class:"team-name"},We={class:"predict-area"},Ne={class:"predict-row"},Oe={class:"predict-block"},qe={class:"predict-label"},Ge=["src","alt"],He={class:"team-name"},Ke=["onClick","disabled"],Ze={class:"predict-block"},Je={class:"predict-label"},Qe=["src","alt"],Xe={class:"team-name"},Ye=["onClick","disabled"],et={class:"predict-row advance-row"},tt={class:"advance-label"},at=["src","alt"],st={class:"team-name"},ot=["onClick","disabled"],it=q({name:"MatchPredictionBase"}),nt=q({...it,props:{teams:{},firstLabel:{},secondLabel:{},advanceLabel:{},maxAdvance:{},isTimeValid:{type:Boolean}},setup(D,{expose:U}){const f=D,L={name:"teams"},d=p([]),l=p([]),r=p([]),u=p([]);Q(()=>f.teams,t=>{const a=Array.from(new Map(t.map(e=>[e.id,e])).values());d.value=[...a]},{immediate:!0});function b(t){const a=t.draggedContext.element;return t.from&&!t.from.classList.contains("team-list")&&t.to.classList.contains("predict-slot")?!0:!($(a.id,a.name)||l.value.length>=2)}function v(t){const a=t.draggedContext.element;return t.from&&!t.from.classList.contains("team-list")&&t.to.classList.contains("predict-slot")?!0:!($(a.id,a.name)||r.value.length>=2)}function h(t){const a=t.draggedContext.element;return!w(t.from)&&t.to.classList.contains("predict-slot")?!0:!$(a.id,a.name)}function w(t){return t&&t.classList&&t.classList.contains("team-list")}function $(t,a){return l.value.some(e=>e.id===t||e.name===a)||r.value.some(e=>e.id===t||e.name===a)||u.value.some(e=>e.id===t||e.name===a)}function I(t){if(t.added){const e=t.added.element;r.value=r.value.filter(i=>i.id!==e.id),u.value=u.value.filter(i=>i.id!==e.id)}if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(l.value.map(e=>[e.id,e])).values());l.value.splice(0,l.value.length,...a),l.value.length>2&&l.value.splice(2).forEach(i=>{d.value.some(y=>y.id===i.id)||d.value.push(i)}),s()}function E(t){if(t.added){const e=t.added.element;l.value=l.value.filter(i=>i.id!==e.id),u.value=u.value.filter(i=>i.id!==e.id)}if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(r.value.map(e=>[e.id,e])).values());r.value.splice(0,r.value.length,...a),r.value.length>2&&r.value.splice(2).forEach(i=>{d.value.some(y=>y.id===i.id)||d.value.push(i)}),s()}function z(t){if(t.added){const e=t.added.element;if(!t.from.classList.contains("team-list")&&t.added.newIndex!==void 0){if(t.removed){const i=t.removed.element;d.value.some(y=>y.id===i.id)||d.value.push(i)}}else if(u.value.length>f.maxAdvance&&t.removed){const i=t.removed.element;d.value.some(y=>y.id===i.id)||d.value.push(i)}l.value=l.value.filter(i=>i.id!==e.id),r.value=r.value.filter(i=>i.id!==e.id)}else if(t.removed){const e=t.removed.element;d.value.some(i=>i.id===e.id)||d.value.push(e)}const a=Array.from(new Map(u.value.map(e=>[e.id,e])).values());u.value.splice(0,u.value.length,...a),s()}function V(t,a){let e;t==="first"?e=l.value.splice(a,1):e=r.value.splice(a,1),d.value.push(...e),s()}function m(t){const a=u.value.splice(t,1);d.value.push(...a),s()}function s(){he(()=>{const t=[...l.value.map(a=>a.id),...r.value.map(a=>a.id),...u.value.map(a=>a.id)];d.value=d.value.filter(a=>!t.includes(a.id))})}return U({firstTeam:l,secondTeam:r,advanceTeams:u}),(t,a)=>(_(),T("div",Be,[o("div",Ue,[C(O(K),{list:d.value,group:L,sort:!1,"item-key":"id",class:"team-list","ghost-class":"ghost",disabled:!t.isTimeValid},{item:M(({element:e})=>[(_(),T("div",{class:B(["team-card",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,Fe),o("div",je,P(e.name),1)],2))]),_:1},8,["list","disabled"])]),o("div",We,[o("div",Ne,[o("div",Oe,[o("div",qe,P(t.firstLabel),1),C(O(K),{list:l.value,group:L,sort:!1,"item-key":"id",class:"predict-slot big","ghost-class":"ghost",move:b,onChange:I,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:B(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,Ge),o("div",He,P(e.name),1),o("button",{class:"remove-btn",onClick:ne(y=>V("first",i),["stop"]),disabled:!t.isTimeValid},"×",8,Ke)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,2-l.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])]),o("div",Ze,[o("div",Je,P(t.secondLabel),1),C(O(K),{list:r.value,group:L,sort:!1,"item-key":"id",class:"predict-slot big","ghost-class":"ghost",move:v,onChange:E,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:B(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,Qe),o("div",Xe,P(e.name),1),o("button",{class:"remove-btn",onClick:ne(y=>V("second",i),["stop"]),disabled:!t.isTimeValid},"×",8,Ye)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,2-r.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])])]),o("div",et,[o("div",tt,P(t.advanceLabel),1),C(O(K),{list:u.value,group:L,sort:!0,"item-key":"id",class:"predict-slot multi big","ghost-class":"ghost",move:h,onChange:z,disabled:!t.isTimeValid},{item:M(({element:e,index:i})=>[(_(),T("div",{class:B(["team-card selected big",{disabled:!t.isTimeValid}]),key:e.id},[o("img",{src:e.logo,alt:e.name,class:"team-logo big"},null,8,at),o("div",st,P(e.name),1),o("button",{class:"remove-btn",onClick:ne(y=>m(i),["stop"]),disabled:!t.isTimeValid},"×",8,ot)],2))]),footer:M(()=>[(_(!0),T(le,null,de(Math.max(0,t.maxAdvance-u.value.length),e=>(_(),T("div",{key:e,class:"empty-slot big"},"?"))),128))]),_:1},8,["list","disabled"])])])]))}}),lt=X(nt,[["__scopeId","data-v-7543f671"]]),J={getMatchTeams(D,U){return Z.get(`/machine/matches/${D}/teams`,{params:{phase:U}})},submitPrediction(D){return Z.post("/machine/prediction/submit",D)},getUserPredictions(D){return Z.get("/machine/prediction/records",{params:{matchId:D.matchId,phase:D.phase}})}},dt={class:"major-phase","element-loading-text":"加载队伍数据中..."},rt={class:"title"},ct={class:"save-button"},ut=q({name:"MajorPhase"}),mt=q({...ut,props:{isTimeValid:{type:Boolean},matchId:{},phase:{}},setup(D,{expose:U}){const f=D,L=te(()=>({onePhase:"第一阶段",twoPhase:"第二阶段",threePhase:"第三阶段"})[f.phase]),d=_e(),l=p(),r=p([]),u=p([]),b=p([]),v=p([]),h=p(!1),w=p(!1),I=((s,t)=>{let a=null;return function(...e){a&&clearTimeout(a),a=setTimeout(()=>{s.apply(this,e),a=null},t)}})(()=>{f.isTimeValid&&(console.log("触发防抖保存..."),m())},300);Q(l,s=>{s&&Q([()=>s.firstTeam,()=>s.secondTeam,()=>s.advanceTeams],([t,a,e])=>{r.value=[...t],u.value=[...a],b.value=[...e],!h.value&&!w.value&&f.isTimeValid&&I()},{deep:!0})},{immediate:!0});const E=async()=>{try{h.value=!0,console.log(`获取${L.value}队伍数据，matchId:`,f.matchId);const s=await J.getMatchTeams(f.matchId,f.phase);console.log("获取到的原始数据:",s.data),v.value=s.data.map(t=>({id:t.id,name:t.teamName,logo:t.teamImgUrl})),console.log("处理后的队伍数据:",v.value)}catch(s){console.error("获取队伍数据失败:",s),x.error("获取队伍数据失败")}finally{h.value=!1}},z=async()=>{var s;if(!f.matchId){console.warn("matchId未设置，跳过获取预测数据");return}try{w.value=!0,h.value=!0,v.value.length===0&&await E();const t=await J.getUserPredictions({matchId:f.matchId,phase:f.phase,userId:d.userId});if(t.data){let a=Array.isArray(t.data)?t.data[0]:t.data;const e=new Set;if(a.sl){const i=a.sl.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));r.value=y,y.forEach(A=>e.add(A.id.toString()))}if(a.ls){const i=a.ls.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));u.value=y,y.forEach(A=>e.add(A.id.toString()))}if(a.advance){const i=a.advance.split(","),y=v.value.filter(A=>i.includes(A.id.toString()));b.value=y,y.forEach(A=>e.add(A.id.toString()))}v.value=v.value.filter(i=>!e.has(i.id.toString())),l.value&&(l.value.firstTeam=[...r.value],l.value.secondTeam=[...u.value],l.value.advanceTeams=[...b.value])}else console.log("未找到用户之前的预测数据")}catch(t){if(((s=t.response)==null?void 0:s.status)===401){console.log("用户未登录，跳过获取预测数据");return}console.error("获取预测数据失败:",t),x.error("获取预测数据失败")}finally{h.value=!1,setTimeout(()=>{w.value=!1},100)}},V=()=>{const s=[];return r.value.length!==2&&s.push("请选择2支3-0队伍"),u.value.length!==2&&s.push("请选择2支0-3队伍"),b.value.length!==6&&s.push("请选择6支晋级队伍"),s},m=async()=>{var t;const s=V();s.length>0&&x.warning(s.join(`
`));try{const a={matchId:f.matchId,phase:f.phase,s_l:r.value.map(i=>i.id.toString()).join(","),l_s:u.value.map(i=>i.id.toString()).join(","),advance:b.value.map(i=>i.id)},e=await J.submitPrediction(a);x.success("预测数据保存成功")}catch(a){if(((t=a.response)==null?void 0:t.status)===401){x.warning("请先登录后再进行预测");return}console.error("保存预测数据失败:",a),x.error("保存预测数据失败")}};return ae(async()=>{f.matchId&&(await E(),await z())}),U({getPredictData(){return{firstTeam:r.value,secondTeam:u.value,advanceTeams:b.value}},fetchTeams:E,fetchUserPrediction:z,validateAndSavePrediction:m}),(s,t)=>{const a=G("el-button"),e=pe("loading");return fe((_(),T("div",dt,[o("h2",rt,P(L.value)+"竞猜作业",1),C(lt,{ref_key:"predictRef",ref:l,teams:v.value,"first-label":"全胜晋级","second-label":"全败出局","advance-label":"晋级的另外6支队伍","max-advance":6,isTimeValid:s.isTimeValid,"onUpdate:firstTeam":t[0]||(t[0]=i=>r.value=i),"onUpdate:secondTeam":t[1]||(t[1]=i=>u.value=i),"onUpdate:advanceTeams":t[2]||(t[2]=i=>b.value=i)},null,8,["teams","isTimeValid"]),o("div",ct,[C(a,{onClick:m,disabled:!s.isTimeValid},{default:M(()=>[...t[3]||(t[3]=[N("保存预测",-1)])]),_:1},8,["disabled"])])])),[[e,h.value]])}}}),re=X(mt,[["__scopeId","data-v-9a698311"]]),vt={class:"major-champion","element-loading-text":"加载队伍数据中..."},ht={class:"bracket-container"},pt={class:"bracket-stage"},ft={class:"matches"},gt={class:"match"},_t=["src","alt"],wt={class:"team-name"},Tt={key:0,class:"empty-slot"},bt={class:"bracket-stage champion-stage"},yt={class:"matches"},kt=["src","alt"],Pt={class:"team-name"},Ct=["onClick","disabled"],$t={key:0,class:"empty-slot champion-empty"},It={class:"save-button"},St=q({name:"MajorChampion"}),Mt=q({...St,props:{isTimeValid:{type:Boolean},matchId:{}},setup(D,{expose:U}){const f=D,L=_e(),d=p(!1),l=p([]),u=((m,s)=>{let t=null;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{m.apply(this,a),t=null},s)}})(()=>{f.isTimeValid&&(console.log("触发防抖保存冠军预测..."),V())},300),b=async()=>{try{d.value=!0,console.log("获取冠军组队伍数据，matchId:",f.matchId);const m=await J.getMatchTeams(f.matchId,"champion");console.log("获取到的原始数据:",m.data),l.value=m.data.map(s=>({id:s.id,name:s.teamName,logo:s.teamImgUrl})),console.log("处理后的队伍数据:",l.value)}catch(m){console.error("获取队伍数据失败:",m),x.error("获取队伍数据失败")}finally{d.value=!1}},v=async()=>{var m;if(!f.matchId){console.warn("matchId未设置，跳过获取预测数据");return}try{d.value=!0,l.value.length===0&&await b();const s=await J.getUserPredictions({matchId:f.matchId,phase:"champion",userId:L.userId});if(s.data){let t=Array.isArray(s.data)?s.data[0]:s.data;const a=new Set;if(t.advance){const e=t.advance.split(","),i=l.value.filter(y=>e.includes(y.id.toString()));w.value=i,i.forEach(y=>a.add(y.id.toString()))}l.value=l.value.filter(e=>!a.has(e.id.toString()))}else console.log("未找到用户之前的预测数据")}catch(s){if(((m=s.response)==null?void 0:m.status)===401){console.log("用户未登录，跳过获取预测数据");return}console.error("获取预测数据失败:",s),x.error("获取预测数据失败")}finally{d.value=!1}};ae(async()=>{f.matchId&&(await b(),await v())});const h={name:"teams"},w=p([]);Q(w,()=>{u()},{deep:!0});const $=m=>{switch(m){case"champion":return w;default:return p([])}},I=m=>{const s=m.from.parentElement.id,t=m.to.parentElement.id;return!s||!t?!1:t==="champion"},E=(m,s)=>{if(m.added){const t=m.added.element;if(w.value.length>1){const a=w.value.findIndex(e=>e.id!==t.id);if(a!==-1){const e=w.value.splice(a,1)[0];l.value.push(e),l.value.sort((i,y)=>i.id-y.id)}}}else if(m.removed){const t=m.removed.element;l.value.some(a=>a.id===t.id)||(l.value.push(t),l.value.sort((a,e)=>a.id-e.id))}};function z(m,s){const t=$(m),a=t.value.findIndex(e=>e.id===s);if(a!==-1){const e=t.value.splice(a,1)[0];l.value.push(e),l.value.sort((i,y)=>i.id-y.id)}}const V=async()=>{var m;if(w.value.length!==1){x.warning("请选择一支冠军队伍！");return}try{const s={matchId:f.matchId,phase:"champion",s_l:"",l_s:"",advance:[w.value[0].id],champion:""},t=await J.submitPrediction(s);x.success("冠军预测保存成功！")}catch(s){if(((m=s.response)==null?void 0:m.status)===401){x.warning("请先登录后再进行预测！");return}console.error("保存冠军预测失败:",s),x.error("保存冠军预测失败！")}};return U({getPredictData(){return{champion:w.value}},fetchTeams:b,fetchUserPrediction:v,saveChampionPrediction:V}),(m,s)=>{const t=G("el-button"),a=pe("loading");return fe((_(),T("div",vt,[s[5]||(s[5]=o("h2",{class:"title"},"冠军竞猜",-1)),o("div",ht,[o("div",pt,[s[1]||(s[1]=o("div",{class:"stage-title"},"冠军组队伍",-1)),o("div",ft,[o("div",gt,[C(O(K),{list:l.value,group:h,"item-key":"id",class:"slot teams-grid","ghost-class":"ghost",disabled:!m.isTimeValid},{item:M(({element:e})=>[o("div",{class:B(["team-card",{disabled:!m.isTimeValid}])},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,_t),o("div",wt,P(e.name),1)],2)]),footer:M(()=>[l.value.length===0?(_(),T("div",Tt,"暂无队伍")):R("",!0)]),_:1},8,["list","disabled"])])])]),s[3]||(s[3]=o("div",{class:"connector-column third"},null,-1)),o("div",bt,[s[2]||(s[2]=o("div",{class:"stage-title"},"冠军",-1)),o("div",yt,[C(O(K),{id:"champion",list:w.value,group:h,"item-key":"id",class:"slot champion-slot","ghost-class":"ghost",onChange:s[0]||(s[0]=e=>E(e)),move:I,max:1,disabled:!m.isTimeValid},{item:M(({element:e})=>[o("div",{class:B(["team-card selected",{disabled:!m.isTimeValid}])},[o("img",{src:e.logo,alt:e.name,class:"team-logo"},null,8,kt),o("div",Pt,P(e.name),1),o("button",{class:"remove-btn",onClick:ne(i=>z("champion",e.id),["stop"]),disabled:!m.isTimeValid},"×",8,Ct)],2)]),footer:M(()=>[w.value.length===0?(_(),T("div",$t,"？")):R("",!0)]),_:1},8,["list","disabled"])])])]),o("div",It,[C(t,{onClick:V,disabled:!m.isTimeValid},{default:M(()=>[...s[4]||(s[4]=[N("保存预测",-1)])]),_:1},8,["disabled"])])])),[[a,d.value]])}}}),Vt=X(Mt,[["__scopeId","data-v-d2767f82"]]),Lt={class:"coin-buttons"},Dt={key:0,class:"debug-info"},xt=q({__name:"MatchCoinBase",props:{debug:{type:Boolean}},emits:["update:coinType","loading","model-loaded","progress"],setup(D,{emit:U}){const f=D,L=p(f.debug!==void 0?f.debug:!0);console.log("MatchCoinBase - debugInfo:",L.value);const d=p(""),l=p("初始化中..."),r=p(null);let u,b,v,h;const w=U,$={bronze:"#B08D57",silver:"#696969",gold:"#81FF08",diamond:"#BFD8EF"},I=p("gold"),E=a=>{I.value=a,z()},z=()=>{if(!u)return;const a=$[I.value];u.traverse(e=>{e.isMesh&&e.material&&(e.material.color.set(a),e.material.needsUpdate=!0)})},V=()=>{if(r.value){const a=r.value.getBoundingClientRect();d.value=`宽度: ${a.width}px, 高度: ${a.height}px`}},m=()=>{try{if(l.value="创建场景...",u=new $e,console.log("场景创建成功"),l.value="创建相机...",b=new Ie(75,r.value?r.value.clientWidth/r.value.clientHeight:1,.1,1e3),b.position.set(0,0,5),console.log("相机创建成功"),l.value="创建渲染器...",v=new Se({antialias:!0}),!r.value)throw new Error("容器元素不存在");const a=r.value.clientWidth,e=r.value.clientHeight;v.setSize(a,e),v.setPixelRatio(window.devicePixelRatio),r.value.appendChild(v.domElement),console.log("渲染器创建成功，尺寸:",a,e),v.toneMapping=Me,v.toneMappingExposure=1,h=new Ve(b,v.domElement),h.enableDamping=!0,h.dampingFactor=.05,console.log("控制器创建成功");const i=new Le(16777215,1);u.add(i);const y=new me(16777215,1);y.position.set(5,5,5),u.add(y);const A=new me(16777215,.8);A.position.set(-5,5,-5).normalize(),u.add(A);const H=new De(16777215,1,100);H.position.set(0,2,0),u.add(H),console.log("灯光移除，将使用环境贴图提供照明");const Y=new xe(v);Y.compileEquirectangularShader(),l.value="加载环境贴图...",new Ee().load("https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/the_sky_is_on_fire_1k.hdr",c=>{const k=Y.fromEquirectangular(c).texture;Y.dispose(),c.dispose(),u.environment=k,u.background=k,console.log("环境贴图加载并应用成功"),l.value="环境贴图加载成功"},void 0,c=>{console.error("加载环境贴图错误:",c),l.value="环境贴图加载失败: "+(c instanceof Error?c.message:String(c))}),l.value="开始加载模型...";const n=new Ae;console.log("开始加载模型..."),n.load("/b.glb",c=>{console.log("模型加载成功"),l.value="模型加载成功",w("loading",l.value),u.add(c.scene);const k=new Re({metalness:1,roughness:0,color:$[I.value]});u.traverse(j=>{j.isMesh&&(console.log("检查到网格对象:",j.name),j.material=k,console.log("已为网格对象应用 MeshStandardMaterial"),(j.material.isMeshStandardMaterial||j.material.isMeshPhysicalMaterial)&&u.environment&&(j.material.envMap=u.environment,j.material.needsUpdate=!0,console.log("已为标准/物理材质设置环境贴图")))});const S=new ze().setFromObject(c.scene),F=S.getCenter(new ve),W=S.getSize(new ve),se=Math.max(W.x,W.y,W.z),oe=b.fov*(Math.PI/180);let ie=Math.abs(se/Math.sin(oe/2))*.8;b.position.set(F.x-ie,F.y,F.z),b.lookAt(F),h.target.copy(F),h.update(),console.log("相机位置调整完成"),setTimeout(()=>{console.log("发送模型加载完成事件"),w("model-loaded")},100)},c=>{const k=c.loaded/c.total*100;console.log("加载进度:",k.toFixed(2)+"%"),l.value=`模型加载进度: ${k.toFixed(0)}%`,w("loading",l.value),w("progress",k)},c=>{console.error("模型加载错误:",c),l.value="模型加载失败: "+(c instanceof Error?c.message:String(c)),w("loading",l.value)}),V()}catch(a){console.error("初始化场景失败:",a),l.value="初始化失败: "+a.message}},s=()=>{requestAnimationFrame(s),h==null||h.update(),v==null||v.render(u,b)},t=()=>{if(!r.value||!b||!v)return;const a=r.value.clientWidth,e=r.value.clientHeight;console.log("handleResize - 容器尺寸:",a,e),b.aspect=r.value?a/e:b.aspect,b.updateProjectionMatrix(),v.setSize(a,e),V(),console.log("handleResize - 相机宽高比更新为:",b.aspect)};return ae(()=>{console.log("组件挂载，容器元素:",r.value),window.addEventListener("resize",t),l.value="初始化场景...",he(()=>{var a,e;V(),console.log("nextTick - 容器尺寸:",(a=r.value)==null?void 0:a.clientWidth,(e=r.value)==null?void 0:e.clientHeight),r.value&&console.log("nextTick - 相机宽高比:",r.value.clientWidth/r.value.clientHeight),m(),s()})}),ge(()=>{window.removeEventListener("resize",t),r.value&&v&&r.value.removeChild(v.domElement),v==null||v.dispose(),u&&u.traverse(a=>{if(a.geometry&&a.geometry.dispose(),a.material)if(Array.isArray(a.material))for(const e of a.material)e.dispose();else a.material.dispose();a.texture&&a.texture.dispose()})}),(a,e)=>(_(),T("div",{class:"model-container",ref_key:"container",ref:r},[o("div",Lt,[o("button",{onClick:e[0]||(e[0]=i=>E("bronze")),class:B({active:I.value==="bronze"})},"铜币",2),o("button",{onClick:e[1]||(e[1]=i=>E("silver")),class:B({active:I.value==="silver"})},"银币",2),o("button",{onClick:e[2]||(e[2]=i=>E("gold")),class:B({active:I.value==="gold"})},"金币",2),o("button",{onClick:e[3]||(e[3]=i=>E("diamond")),class:B({active:I.value==="diamond"})},"钻石币",2)]),L.value?(_(),T("div",Dt,[o("p",null,"容器尺寸: "+P(d.value),1),o("p",null,"加载状态: "+P(l.value),1)])):R("",!0)],512))}}),Et=X(xt,[["__scopeId","data-v-fe16f9e7"]]),At={class:"coin-preview-container"},Rt={key:0,class:"loading-overlay"},zt={class:"loading-text"},Bt={class:"dialog-footer"},Ut=q({__name:"CoinPreviewDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(D,{emit:U}){const f=D,L=U,d=te({get:()=>f.modelValue,set:s=>L("update:modelValue",s)}),l=p("gold"),r=p(!1),u=te(()=>r.value?"100%":"80%"),b=te(()=>r.value?"80vh":"70vh"),v=p(!0),h=p(0),w=p("初始化..."),$=()=>{r.value=window.innerWidth<=768},I=s=>{l.value=s},E=s=>{w.value=s,console.log("加载状态:",s)},z=s=>{h.value=Math.floor(s),h.value>=100&&(w.value="加载完成...")},V=()=>{console.log("收到模型加载完成事件"),setTimeout(()=>{v.value=!1,h.value=100,w.value="加载完成",console.log("加载叠加层应已隐藏")},300)},m=()=>{v.value=!0,h.value=0,w.value="初始化...",l.value="gold"};return ae(()=>{$(),window.addEventListener("resize",$)}),ge(()=>{window.removeEventListener("resize",$)}),Q(d,s=>{console.log("对话框状态变化:",s),s&&(v.value=!0,h.value=0,w.value="初始化...")}),(s,t)=>{const a=G("el-button"),e=G("el-dialog");return _(),we(e,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=i=>d.value=i),title:"3D预览奖章,加载约30秒左右",width:u.value,fullscreen:!r.value,draggable:"","destroy-on-close":"",onClosed:m,"close-on-click-modal":!1},{footer:M(()=>[o("div",Bt,[C(a,{onClick:t[0]||(t[0]=i=>d.value=!1)},{default:M(()=>[...t[2]||(t[2]=[N("关闭",-1)])]),_:1})])]),default:M(()=>[o("div",At,[C(Et,{ref:"coinViewer",debug:!1,"initial-coin-type":l.value,"container-height":b.value,"onUpdate:coinType":I,onLoading:E,onModelLoaded:V,onProgress:z},null,8,["initial-coin-type","container-height"]),v.value||h.value<100?(_(),T("div",Rt,[C(O(be),{type:"circle",percentage:h.value,width:r.value?90:100,"stroke-width":10,color:"#409eff"},null,8,["percentage","width"]),o("div",zt,P(w.value),1)])):R("",!0)])]),_:1},8,["modelValue","width","fullscreen"])}}}),Ft=X(Ut,[["__scopeId","data-v-6daef79c"]]),jt={class:"cs2-major-root"},Wt={class:"major-container"},Nt={key:0,class:"loading-container"},Ot={key:1,class:"prediction-content"},qt={class:"tab-buttons"},Gt={key:0,class:"countdown"},Ht={key:0,class:"countdown"},Kt={key:0,class:"countdown"},Zt={key:0,class:"countdown"},Jt={class:"major-content"},Qt={class:"match-info-panel"},Xt={class:"match-header"},Yt=["src","alt"],ea={class:"match-name"},ta={class:"match-details"},aa={class:"info-item"},sa={class:"value"},oa={class:"info-item"},ia={class:"value"},na={class:"info-item"},la={class:"value"},da={class:"match-footer"},ra={class:"button-group"},ca={class:"button-group"},ua={key:0,class:"major-section"},ma={class:"time-info"},va={key:1,class:"major-section"},ha={class:"time-info"},pa={key:2,class:"major-section"},fa={class:"time-info"},ga={key:3,class:"major-section"},_a={class:"time-info"},wa={key:2,class:"no-match"},Ta=q({__name:"CS2Major",setup(D,{expose:U}){ye();const f=p(0),L=p(!0),d=p("onePhase"),l=p(),r=p(),u=p(),b=p(),v=p(null),h=p(null),w=p(!1),$=p({}),I=p({onePhase:{start:new Date,end:new Date},twoPhase:{start:new Date,end:new Date},threePhase:{start:new Date,end:new Date},champion:{start:new Date,end:new Date}}),E=te(()=>Object.keys($.value).length>0),z=g=>new Date(g).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Shanghai"}).replace(/\//g,"年").replace(",","日"),V=g=>{const{start:n,end:c}=I.value[g];return`${z(n.toISOString())}日 ${n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})} - ${z(c.toISOString())}日 ${c.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})}`},m=async()=>{try{L.value=!0;const g=await Z.get("/machine/matches");if(g.data&&g.data.length>0){const n=g.data;n.length>0?(n.forEach(c=>{$.value[c.phase]=c}),$.value[d.value]||(d.value=Object.keys($.value)[0]),s(d.value),n.forEach(c=>{const k=c.phase;k in I.value&&(I.value[k]={start:new Date(c.predictStartTime),end:new Date(c.predictEndTime)})}),console.log("比赛信息:",n),console.log("时间限制设置:",I.value)):x.error("未找到可用赛事")}else x.error("未找到可用赛事")}catch(g){console.error("获取赛事ID失败:",g),x.error("获取赛事ID失败")}finally{L.value=!1}},s=g=>{const n=$.value[g];n?(f.value=n.id||0,h.value=n):(f.value=0,h.value=null)},t=g=>{const n=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Shanghai"})),{start:c,end:k}=I.value[g];return n>=c&&n<=k},a=g=>{const n=new Date,{start:c,end:k}=I.value[g];if(n<c){const S=c.getTime()-n.getTime();return`距离开始还有 ${e(S)}`}else{if(n>k)return"竞猜已结束";{const S=k.getTime()-n.getTime();return`距离结束还有 ${e(S)}`}}},e=g=>{const n=Math.floor(g/864e5),c=Math.floor(g%(1e3*60*60*24)/(1e3*60*60)),k=Math.floor(g%(1e3*60*60)/(1e3*60)),S=Math.floor(g%(1e3*60)/1e3);return`${n}天${c}小时${k}分${S}秒`},i=()=>{d.value=d.value};Q(d,g=>{var n,c,k,S;if(s(g),f.value)switch(g){case"onePhase":(n=l.value)==null||n.fetchTeams();break;case"twoPhase":(c=r.value)==null||c.fetchTeams();break;case"threePhase":(k=u.value)==null||k.fetchTeams();break;case"champion":(S=b.value)==null||S.fetchTeams();break}}),ae(async()=>{await m(),v.value=window.setInterval(i,1e3)}),Te(()=>{v.value&&clearInterval(v.value)}),U({getPredictData(){var g,n,c,k;return{onePhase:(g=l.value)==null?void 0:g.getPredictData(),twoPhase:(n=r.value)==null?void 0:n.getPredictData(),threePhase:(c=u.value)==null?void 0:c.getPredictData(),champion:(k=b.value)==null?void 0:k.getPredictData()}}});const y=g=>{const n=document.createElement("canvas");n.width=g.width,n.height=g.height+60;const c=n.getContext("2d");if(!c)return g;c.drawImage(g,0,0),c.font="bold 36px Microsoft YaHei",c.textAlign="center",c.textBaseline="bottom";const k="竞猜作业来源：sb6657.cn",S=n.width/2,F=n.height-20,W=c.measureText(k).width;return c.fillStyle="rgba(0, 0, 0, 0.5)",c.fillRect(S-W/2-10,F-40,W+20,40),c.fillStyle="#ffffff",c.fillText(k,S,F),n},A=async()=>{const g="玩机器烂梗库官方比赛作业，地址sb6657.cn";try{await navigator.clipboard.writeText(g)}catch(n){console.error("复制失败:",n)}try{w.value=!0;const n=document.querySelector(".major-section");if(!n)throw new Error("未找到要截图的元素");const c=await Ce(n,{backgroundColor:"#ffffff",scale:1.5,logging:!1,useCORS:!0,allowTaint:!0}),k=y(c),S=document.createElement("a");S.download=`sb6657.cn_CS2Major预测_${new Date().toLocaleDateString()}.jpg`,S.href=k.toDataURL("image/jpeg",1),S.click(),x.success("截图已保存"),Z.get("/machine/shareMatch")}catch(n){console.error("截图失败:",n),x.error("截图失败，请重试")}finally{w.value=!1}},H=p(!1);function Y(){H.value=!0,Z.get("/machine/matchCoin")}return(g,n)=>{var W,se,oe,ie,j,ce,ue;const c=G("el-skeleton"),k=G("el-icon"),S=G("el-button"),F=G("el-empty");return _(),T("div",jt,[o("div",Wt,[L.value?(_(),T("div",Nt,[C(c,{rows:3,animated:""})])):E.value?(_(),T("div",Ot,[o("div",qt,[$.value.onePhase?(_(),T("button",{key:0,class:B({active:d.value==="onePhase"}),onClick:n[0]||(n[0]=ee=>d.value="onePhase")},[n[5]||(n[5]=N(" 第一阶段 ",-1)),d.value==="onePhase"?(_(),T("div",Gt,P(a("onePhase")),1)):R("",!0)],2)):R("",!0),$.value.twoPhase?(_(),T("button",{key:1,class:B({active:d.value==="twoPhase"}),onClick:n[1]||(n[1]=ee=>d.value="twoPhase")},[n[6]||(n[6]=N(" 第二阶段 ",-1)),d.value==="twoPhase"?(_(),T("div",Ht,P(a("twoPhase")),1)):R("",!0)],2)):R("",!0),$.value.threePhase?(_(),T("button",{key:2,class:B({active:d.value==="threePhase"}),onClick:n[2]||(n[2]=ee=>d.value="threePhase")},[n[7]||(n[7]=N(" 第三阶段 ",-1)),d.value==="threePhase"?(_(),T("div",Kt,P(a("threePhase")),1)):R("",!0)],2)):R("",!0),$.value.champion?(_(),T("button",{key:3,class:B({active:d.value==="champion"}),onClick:n[3]||(n[3]=ee=>d.value="champion")},[n[8]||(n[8]=N(" 冠军组 ",-1)),d.value==="champion"?(_(),T("div",Zt,P(a("champion")),1)):R("",!0)],2)):R("",!0)]),o("div",Jt,[o("div",Qt,[o("div",Xt,[o("img",{src:(W=h.value)==null?void 0:W.matchesImg,alt:(se=h.value)==null?void 0:se.matchesName,class:"match-logo"},null,8,Yt),o("h2",ea,P((oe=h.value)==null?void 0:oe.matchesName),1)]),o("div",ta,[o("div",aa,[n[9]||(n[9]=o("span",{class:"label"},"赛事等级：",-1)),o("span",sa,P((ie=h.value)==null?void 0:ie.level),1)]),o("div",oa,[n[10]||(n[10]=o("span",{class:"label"},"比赛地点：",-1)),o("span",ia,P((j=h.value)==null?void 0:j.matchesLocation),1)]),o("div",na,[n[11]||(n[11]=o("span",{class:"label"},"比赛时间：",-1)),o("span",la,P(z((ce=h.value)==null?void 0:ce.startTime))+"日 - "+P(z((ue=h.value)==null?void 0:ue.endTime))+"日",1)])]),o("div",da,[o("div",ra,[C(S,{type:"primary",onClick:A,loading:w.value},{default:M(()=>[C(k,null,{default:M(()=>[C(O(ke))]),_:1}),n[12]||(n[12]=N(" 截图分享预测 ",-1))]),_:1},8,["loading"])]),o("div",ca,[C(S,{type:"success",onClick:Y},{default:M(()=>[C(k,null,{default:M(()=>[C(O(Pe))]),_:1}),n[13]||(n[13]=N(" 预览2025奥斯汀Major3D奖章 ",-1))]),_:1})])])]),d.value==="onePhase"?(_(),T("div",ua,[o("div",ma,[o("p",null,"竞猜时间："+P(V("onePhase")),1)]),C(re,{ref_key:"onePhaseRef",ref:l,isTimeValid:t("onePhase"),matchId:f.value,phase:"onePhase"},null,8,["isTimeValid","matchId"])])):R("",!0),d.value==="twoPhase"?(_(),T("div",va,[o("div",ha,[o("p",null,"竞猜时间："+P(V("twoPhase")),1)]),C(re,{ref_key:"twoPhaseRef",ref:r,isTimeValid:t("twoPhase"),matchId:f.value,phase:"twoPhase"},null,8,["isTimeValid","matchId"])])):R("",!0),d.value==="threePhase"?(_(),T("div",pa,[o("div",fa,[o("p",null,"竞猜时间："+P(V("threePhase")),1)]),C(re,{ref_key:"threePhaseRef",ref:u,isTimeValid:t("threePhase"),matchId:f.value,phase:"threePhase"},null,8,["isTimeValid","matchId"])])):R("",!0),d.value==="champion"?(_(),T("div",ga,[o("div",_a,[o("p",null,"竞猜时间："+P(V("champion")),1)]),C(Vt,{ref_key:"championRef",ref:b,isTimeValid:t("champion"),matchId:f.value},null,8,["isTimeValid","matchId"])])):R("",!0)])])):(_(),T("div",wa,[C(F,{description:"暂无可用赛事"})]))]),C(Ft,{modelValue:H.value,"onUpdate:modelValue":n[4]||(n[4]=ee=>H.value=ee)},null,8,["modelValue"])])}}}),Na=X(Ta,[["__scopeId","data-v-83497185"]]);export{Na as default};
